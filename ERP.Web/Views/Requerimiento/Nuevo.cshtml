@model Mantenimiento.Negocio.Poco.GestionarRequerimientoPoco

@{
    Layout = "~/Views/Shared/_Layout2.cshtml";
}

<style>
    .pr-md-custom {
        padding-right: 5px !important;
    }
    .pl-md-custom {
        padding-left: 5px !important;
    }
}
</style>
<!--begin::Content wrapper-->
<div class="d-flex flex-column flex-column-fluid">
    <!--begin::Toolbar-->
    <div id="kt_app_toolbar" class="app-toolbar pt-7 pt-lg-10">
        <!--begin::Toolbar container-->
        <div id="kt_app_toolbar_container" class="app-container container-fluid d-flex align-items-stretch">
            <!--begin::Toolbar wrapper-->
            <div class="app-toolbar-wrapper d-flex flex-stack flex-wrap gap-4 w-100">
                <!--begin::Page title-->
                <div class="page-title d-flex flex-column justify-content-center gap-1 me-3">
                    <!--begin::Title-->
                    <h1 class="page-heading d-flex flex-column justify-content-center text-dark fw-bold fs-3 m-0">
                        Nuevo
                        Requerimiento
                    </h1>
                    <!--end::Title-->
                    <!--begin::Breadcrumb-->
                    <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0">
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">
                            <a href="@Url.Action("Index","Cliente")" class="text-muted text-hover-primary">Home</a>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-400 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">Proceso</li>
                        <!--end::Item-->
                    </ul>
                    <!--end::Breadcrumb-->
                </div>
                <!--end::Page title-->
            </div>
            <!--end::Toolbar wrapper-->
        </div>
        <!--end::Toolbar container-->
    </div>
    <!--end::Toolbar-->
    <!--begin::Content-->
    <div id="kt_app_content" class="app-content flex-column-fluid">
        <!--begin::Content container-->
        <div id="kt_app_content_container" class="app-container container-fluid">
            <!--begin::Form-->
            <form id="kt_add_cliente_form" class="form d-flex flex-column flex-lg-row">
                <!--begin::Main column-->
                <div class="d-flex flex-column flex-row-fluid gap-7 gap-lg-10">
                    <div class="d-flex flex-column gap-7 gap-lg-10">
                        <!--begin::General options-->
                        <div class="card card-flush py-4">
                            <!--begin::Card header-->
                            <div class="card-header card-header-tabs-line">
                                <!--begin::Card title-->
                                <div class="card-title">
                                    <h3 class="fw-bold m-0">Datos de Requerimiento</h3>
                                </div>
                                <!--end::Card title-->
                            </div>
                            <!--end::Card header-->
                            <!--begin::Card body-->
                            <div class="card-body pt-0">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="row mb-5 gx-1">
                                            <!--begin::Input group-->
                                            <!--begin::Label-->
                                            <label class="fs-5 fw-semibold mb-2"
                                                   for="txtCodigo">CÓDIGO:</label>
                                            <!--end::Label-->
                                            <!--begin::Input-->
                                            <input type="text" id="txtCodigo"
                                                   class="form-control"
                                                   placeholder="Codigo"
                                                   value="@Model.Codigo"
                                                   disabled />
                                            <!--end::Input-->
                                            <!--end::Input group-->
                                        </div>
                                        <div class="row mb-5 gx-1">
                                            <!--begin::Label-->
                                            <label class="required fs-5 fw-semibold mb-2"
                                                   for="kt_cliente_select">CLIENTE:</label>
                                            <!--end::Label-->
                                            <!--begin::Select-->
                                            <select id="kt_cliente_select" class="form-select" data-control="select2">
                                                <!-- Opción por defecto -->
                                                <option value="">Seleccione cliente</option>
                                                @if (Model.ListarClientes.Any())
                                                {
                                                    foreach (var item in Model.ListarClientes)
                                                    {
                                                        <option value="@item.idPersona">@item.nombreCli</option>
                                                    }
                                                }
                                                else
                                                {
                                                    // Si no hay clientes disponibles, mostrar una opción por defecto
                                                    <option value="">No existen clientes</option>
                                                }
                                            </select>
                                            <!--end::Select-->
                                        </div>
                                        <div class="row mb-5 gx-1">
                                            <!--begin::Label-->
                                            <label class="fs-5 fw-semibold mb-2"
                                                   for="kt_proyecto_cliente_select">PROYECTO:</label>
                                            <!--end::Label-->
                                            <!--begin::Select-->
                                            <select id="kt_proyecto_cliente_select" class="form-select" data-control="select2">
                                                <!-- Opción por defecto -->
                                                <option value="">Seleccione Proyecto</option>
                                                @if (Model.ListarProyectos.Any())
                                                {
                                                    foreach (var item in Model.ListarProyectos)
                                                    {
                                                        <option value="@item.idProyecto">@item.nombre</option>
                                                    }
                                                }
                                                else
                                                {
                                                    // Si no hay proyectos disponibles, mostrar una opción por defecto
                                                    <option value="">No existen proyectos</option>
                                                }
                                            </select>
                                            <!--end::Select-->
                                        </div>
                                        <div class="row mb-5 gx-1">
                                            <!--begin::Input group-->
                                            <!--begin::Label-->
                                            <label class="required fs-5 fw-semibold mb-2"
                                                   for="txtSolicitante">SOLICITANTE:</label>
                                            <!--end::Label-->
                                            <!--begin::Input-->
                                            <input type="text" id="txtSolicitante"
                                                   class="form-control"
                                                   placeholder="Ingrese nombre del solicitante" />
                                            <!--end::Input-->
                                            <!--end::Input group-->
                                        </div>
                                        <div class="row mb-5 gx-1">
                                            <!--begin::Label-->
                                            <label class="required fs-5 fw-semibold mb-2"
                                                   for="kt_tipo_req_select">TIPO DE REQUERIMIENTO:</label>
                                            <!--end::Label-->
                                            <!--begin::Select-->
                                            <select id="kt_tipo_req_select" class="form-select" data-control="select2">
                                                <!-- Opción por defecto -->
                                                <option value="">Seleccione Tipo de Requerimiento</option>
                                                @if (Model.ListarTipoRequerimientos.Any())
                                                {
                                                    foreach (var item in Model.ListarTipoRequerimientos)
                                                    {
                                                        <option value="@item.idTipoRequerimiento">@item.nombre</option>
                                                    }
                                                }
                                                else
                                                {
                                                    // Si no hay tipos de requerimiento disponibles, mostrar una opción por defecto
                                                    <option value="">No existen tipos de requerimientos</option>
                                                }
                                            </select>
                                            <!--end::Select-->
                                        </div>
                                        <div class="row mb-5 gx-1">
                                            <!--begin::Label-->
                                            <label class="required fs-5 fw-semibold mb-2"
                                                   for="kt_prioridad_select">PRIORIDAD:</label>
                                            <!--end::Label-->
                                            <!--begin::Select-->
                                            <select id="kt_prioridad_select" class="form-select" data-control="select2">
                                                <option value="">Seleccione prioridad</option>
                                                <option value="1">BAJA</option>
                                                <option value="2">MEDIA</option>
                                                <option value="3">ALTA</option>
                                            </select>
                                            <!--end::Select-->
                                        </div>
                                        <div class="row mb-5 gx-1">
                                            <!--begin::Label-->
                                            <label class="required fs-5 fw-semibold mb-2"
                                                   for="kt_estado_select">ESTADO:</label>
                                            <!--end::Label-->
                                            <!--begin::Select-->
                                            <select id="kt_estado_select" class="form-select" data-control="select2">
                                                <option value="">Seleccione estado</option>
                                                <option value="1">RECIBIDO</option>
                                                <option value="2">EN ANÁLISIS</option>
                                                <option value="3">APROBADO PARA DESARROLLO</option>
                                                <option value="4">EN DESARROLLO</option>
                                                <option value="5">EN QA</option>
                                                <option value="6">OBSERVADO</option>
                                                <option value="7">APROBADO (QA)</option>
                                                <option value="8">EN REVISION DEL CLIENTE</option>
                                                <option value="9">CERRADO</option>
                                                <option value="10">ENTREGADO</option>
                                            </select>
                                            <!--end::Select-->
                                        </div>

                                        <div class="row mb-5 gx-1">
                                            <!--begin::Label-->
                                            <label class="fs-5 fw-semibold mb-2"
                                                   for="kt_proyecto_cliente_select">ORIGEN:</label>
                                            <!--end::Label-->
                                            <!--begin::Select-->
                                            <select id="kt_adicional" class="form-select" data-control="select2">
                                                <!-- Opción por defecto -->
                                                <option value="">Seleccione Adicional</option>
                                                @if (Model.ListarAdicionales.Any())
                                                {
                                                    foreach (var item in Model.ListarAdicionales)
                                                    {
                                                        <option value="@item.idAdicional">@item.nombre</option>
                                                    }
                                                }
                                                else
                                                {
                                                    // Si no hay proyectos disponibles, mostrar una opción por defecto
                                                    <option value="">No existen adicionales</option>
                                                }
                                            </select>
                                            <!--end::Select-->
                                        </div>

                                    </div>
                                    <div class="col-md-6">
                                        <div class="row mb-5 gx-1">
                                            <!--begin::Input group-->
                                            <!--begin::Label-->
                                            <label class="fs-5 fw-semibold mb-2"
                                                   for="kt_datepicker_fecha">FECHA:</label>
                                            <!--end::Label-->
                                            <!--begin::Input-->
                                            <input type="text"
                                                   id="kt_datepicker_fecha"
                                                   class="form-control"
                                                   placeholder="Fecha"
                                                   disabled />
                                            <!--end::Input-->
                                        </div>
                                        <div class="row mb-5 gx-1">
                                            <!--begin::Input group-->
                                            <!--begin::Label-->
                                            <label class="fs-5 fw-semibold mb-2"
                                                   for="kt_datepicker_fecha_ini">FECHA INICIO:</label>
                                            <!--end::Label-->
                                            <!--begin::Input-->
                                            <input type="text"
                                                   id="kt_datepicker_fecha_ini"
                                                   class="form-control"
                                                   placeholder="Fecha" />
                                            <!--end::Input-->
                                        </div>
                                        <div class="row mb-5 gx-1">
                                            <!--begin::Input group-->
                                            <!--begin::Label-->
                                            <label class="fs-5 fw-semibold mb-2"
                                                   for="kt_datepicker_fecha_fin">FECHA FIN:</label>
                                            <!--end::Label-->
                                            <!--begin::Input-->
                                            <input type="text"
                                                   id="kt_datepicker_fecha_fin"
                                                   class="form-control"
                                                   placeholder="Fecha" />
                                            <!--end::Input
                                        <!--end::Input group-->
                                        </div>
                                        <div class="row mb-5 gx-1">
                                            <!--begin::Input group-->
                                            <label class="required fs-5 fw-semibold mb-2" for="txtTiempo">TIEMPO:</label>
                                            <input type="text" id="txtTiempo"
                                                   class="form-control"
                                                   placeholder="Ingrese el tiempo"
                                                   oninput="filtrarNumerosYPuntuacion(this)">
                                            <!--end::Input group-->
                                        </div>
                                        <div class="row mb-5 gx-1">
                                            <!--begin::Input group-->
                                            <!--begin::Label-->
                                            <label class="required fs-5 fw-semibold mb-2"
                                                   for="txtAvanceDesa">% AVANCE DESARROLLO:</label>
                                            <!--end::Label-->
                                            <!--begin::Input-->
                                            <input type="text" id="txtAvanceDesa"
                                                   class="form-control"
                                                   placeholder="0"
                                                   disabled />
                                            <!--end::Input-->
                                            <!--end::Input group-->
                                        </div>
                                        <div class="row mb-5 gx-1">
                                            <!--begin::Input group-->
                                            <!--begin::Label-->
                                            <label class="required fs-5 fw-semibold mb-2"
                                                   for="txtAprobacion">% APROBACIÓN:</label>
                                            <!--end::Label-->
                                            <!--begin::Input-->
                                            <input type="text" id="txtAprobacion"
                                                   class="form-control"
                                                   placeholder="0"
                                                   disabled />
                                            <!--end::Input-->
                                            <!--end::Input group-->
                                        </div>
                                        <div class="row mb-5 gx-1">
                                            <!--begin::Input group-->
                                            <!--begin::Label-->
                                            <label class="required fs-5 fw-semibold mb-2" for="txtResumen">
                                                RESUMEN:
                                            </label>
                                            <!--end::Label-->
                                            <!--begin::Input-->
                                            <textarea type="text" id="txtResumen" class="form-control" placeholder="Ingrese resúmen de requerimiento" style="height: 130px;" maxlength="300"></textarea>
                                            <!--end::Input group-->
                                        </div>
                                    </div>
                                </div>
                                <!--end::Card header-->
                            </div>
                        </div>
                        <div class="card card-flush py-4">
                            <!--begin::Card header-->
                            <div class="card-header card-header-tabs-line">
                                <!--begin::Card title-->
                                <div class="card-title">
                                    <h3 class="fw-bold m-0">Detalle de Requerimiento</h3>
                                </div>
                                <!--end::Card title-->
                            </div>
                            <!--end::Card header-->
                            <!--begin::Card body-->
                            @{
                                int counter = 0; // Inicializa el contador
                            }
                            <div class="card-body pt-0">
                                <div class="row">
                                    <!--begin::Repeater-->
                                    <div id="kt_docs_repeater_basic">
                                        <div data-repeater-list="kt_docs_repeater_basic" data-accion="N">
                                            <div data-repeater-item data-id="{{counter}}">
                                                <div class="form-group mb-4">
                                                    <div class="row mb-5 gx-1">
                                                        <label class="form-label required" for="txtDescripcion_{{counter}}">DESCRIPCIÓN:</label>
                                                        <textarea type="text" class="form-control" id="txtDescripcion_{{counter}}" placeholder="Ingrese descripción" style="height: 70px;" maxlength="300"></textarea>
                                                    </div>
                                                    <div class="row mb-5 gx-1">
                                                        <label class="form-label required" for="txtModulo_{{counter}}">MODULO:</label>
                                                        <textarea type="text" class="form-control" id="txtModulo_{{counter}}" placeholder="Ingrese modulo" style="height: 70px;" maxlength="300"></textarea>
                                                    </div>

                                                    <div class="row mb-5 gx-1">
                                                        <div class="col-md-4 mb-4">
                                                            <label class="form-label" for="kt_estado_desa_select_{{counter}}">ESTADO DESARROLLO:</label>
                                                            <!--begin::Select-->
                                                            <select class="form-select" data-kt-repeater="select2" id="kt_estado_desa_select_{{counter}}" style="font-size: 11px;">
                                                                <option value="">Seleccione estado desarrollo</option>
                                                                <option value="1" selected>PENDIENTE</option>
                                                                <option value="2">EN PROCESO</option>
                                                                <option value="3">FINALIZADO</option>
                                                            </select>
                                                            <!--end::Select-->
                                                        </div>
                                                        <div class="col-md-4 mb-4 gx-md-10">
                                                            <label class="form-label" for="kt_estado_cliente_select_{{counter}}">ESTADO CLIENTE:</label>
                                                            <select class="form-select" data-kt-repeater="select2" id="kt_estado_cliente_select_{{counter}}" style="font-size: 11px;">
                                                                <option value="">Seleccione estado cliente</option>
                                                                <option value="1">APROBADO</option>
                                                                <option value="2" selected>NO APROBADO</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label class="form-label" for="kt_trabajador_select_{{counter}}">ASIGNADO A:</label>
                                                            <select class="form-select" data-kt-repeater="select2" id="kt_trabajador_select_{{counter}}" style="font-size: 11px;">
                                                                <!-- Opción por defecto -->
                                                                <option value="">Seleccione Trabajador</option>
                                                                @if (Model.ListarTrabajadores.Any())
                                                                {
                                                                    foreach (var item in Model.ListarTrabajadores)
                                                                    {
                                                                        <option value="@item.idPersona">@item.nombreCli</option>

                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    // Si no hay trabajadores disponibles, mostrar una opción por defecto
                                                                    <option value="">No existen trabajadores</option>

                                                                }
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="row mb-5 gx-5">
                                                        <div class="col-md-6 mb-4">
                                                            <!--begin::Input group-->
                                                            <!--begin::Label-->
                                                            <label class="form-label"
                                                                   for="kt_datepicker_fecha_ini_detalle_{{counter}}">FECHA INICIO:</label>
                                                            <!--end::Label-->
                                                            <!--begin::Input-->
                                                            <input type="text"
                                                                   id="kt_datepicker_fecha_ini_detalle_{{counter}}"
                                                                   class="form-control"
                                                                   data-kt-repeater="datepicker"
                                                                   placeholder="Fecha incio detalle" />
                                                            <!--end::Input-->
                                                            <!--end::Input group-->
                                                        </div>
                                                        <div class="col-md-6 mb-4">
                                                            <!--begin::Input group-->
                                                            <!--begin::Label-->
                                                            <label class="form-label"
                                                                   for="kt_datepicker_fecha_fin_detalle_{{counter}}">FECHA FIN:</label>
                                                            <!--end::Label-->
                                                            <!--begin::Input-->
                                                            <input type="text"
                                                                   id="kt_datepicker_fecha_fin_detalle_{{counter}}"
                                                                   class="form-control"
                                                                   data-kt-repeater="datepicker"
                                                                   placeholder="Fecha fin detalle" />
                                                            <!--end::Input-->
                                                            <!--end::Input group-->
                                                        </div>
                                                    </div>
                                                    <div class="row mb-5 gx-1">
                                                        <!--begin::Input group-->
                                                        <div class="mb-10 fv-row">
                                                            <!--begin::Dropzone-->
                                                            <div class="dropzone" id="kt_dropzonejs_banner_{{counter}}">
                                                                <!--begin::Message-->
                                                                <div class="dz-message needsclick">
                                                                    <i class="ki-duotone ki-file-up fs-3x text-primary"><span class="path1"></span><span class="path2"></span></i>
                                                                    <!--begin::Info-->
                                                                    <div class="ms-4">
                                                                        <h3 class="fs-5 fw-bold text-gray-900 mb-1 ">Suelte los documentos aquí o haga clic para subirlo.</h3>
                                                                    </div>
                                                                    <!--end::Info-->
                                                                </div>
                                                            </div>
                                                            <!--end::Dropzone-->
                                                        </div>
                                                        <!--end::Input group-->
                                                    </div>
                                                    <div class="col-md-12">
                                                        <div class="form-group">
                                                            <label for="criterioAceptacion">Criterio de Aceptación</label>
                                                            <textarea id="criterioAceptacion"
                                                                      name="criterioAceptacion"
                                                                      class="summernote form-control"
                                                                      rows="10">@Model.DetalleRequerimiento.criterioAceptacion</textarea>
                                                        </div>
                                                    </div>
                                                    <div class="row mb-5 gx-1">
                                                        <label class="form-label" for="txtComentario_{{counter}}">SCRIPTS:</label>
                                                        <textarea type="text" class="form-control" id="txtComentario_{{counter}}" placeholder="Ingrese scripts" style="height: 70px;" maxlength="50000"></textarea>
                                                    </div>
                                                    <div class="col-md-12 d-flex justify-content-end">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-light-danger mt-3 mt-md-8">
                                                            <i class="las la-trash fs-5"></i>
                                                            Eliminar
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--begin::Form group-->
                                        <div class="form-group">
                                            <a href="javascript:;" data-repeater-create class="btn btn-light-primary">
                                                <i class="las la-plus fs-5"></i>
                                                Agregar
                                            </a>
                                        </div>
                                        <!--end::Form group-->
                                    </div>
                                    <!--end::Repeater-->
                                </div>
                                <!--end::General options-->
                            </div>
                            <!--end::Card body-->
                            <div class="d-flex justify-content-end">
                                <!--begin::Button-->
                                <a href="@Url.Action("Index","Requerimiento")" id="kt_cancel_requirement"
                                   class="btn btn-light me-5">
                                    Cancelar
                                </a>
                                <!--end::Button-->
                                <!--begin::Button-->
                                <button type="button" id="btnGuardar" onclick="Guardar();" class="btn btn-primary">
                                    <span class="indicator-label">Guardar</span>
                                    <span class="indicator-progress">
                                        Espere un momento...
                                        <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                                    </span>
                                </button>
                                <!--end::Button-->
                            </div>
                        </div>
                        <!--end::General options-->
                    </div>
                </div>
                <!--end::Main column-->
            </form>
            <!--end::Form-->
        </div>
        <!--end::Content container-->
    </div>
    <!--end::Content-->
</div>
<!--end::Content wrapper-->

@section Scripts {
    <script src="@Url.Content("~/Scripts/library.js?v=5.0")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/metronic/plugins/custom/formrepeater/formrepeater.bundle.js")"></script>

    <script>

        let botonDesactivado = false;

        var ListaDocumentosFile = [];
        var counter = 0;

        function Validar() {

            // Verificar si se ha seleccionado un cliente
            if ($("#kt_cliente_select").val() == "") {
                ShowMessage(0, "Debe seleccionar un cliente");
                return false;
            }
            // Verificar si se ha ingresado un solicitante
            if ($("#txtSolicitante").val() == "") {
                ShowMessage(0, "Debe ingresar nombre de solicitante");
                return false;
            }
            // Verificar si se ha seleccionado un tipo de requerimiento
            if ($("#kt_tipo_req_select").val() == "") {
                ShowMessage(0, "Debe seleccionar un tipo de requerimiento");
                return false;
            }
            // Verificar si se ha seleccionado un tipo de requerimiento
            if ($("#kt_prioridad_select").val() == "") {
                ShowMessage(0, "Debe seleccionar una prioridad");
                return false;
            }
            // Verificar si se ha seleccionado un tipo de requerimiento
            if ($("#kt_estado_select").val() == "") {
                ShowMessage(0, "Debe seleccionar un estado de requerimiento");
                return false;
            }
            // Verificar si se ha ingresado un resumen
            if ($("#txtResumen").val() == "") {
                ShowMessage(0, "Debe ingresar un resumen");
                return false;
            }
            if ($("#txtTiempo").val() == "") {
                ShowMessage(0, "Debe ingresar el tiempo");
                return false;
            }

            //DETALLE REQUERIMIENTO
            // Verificar si se ha ingresado una descripción
            if ($("#txtDescripcion").val() == "") {
                ShowMessage(0, "Debe ingresar una descripción");
                return false;
            }

            return true;
        }

            // Iterar sobre cada fila del repeater Datos de requerimiento
       
            function Guardar() {
                if (!Validar()) {
                    return false;
                }

                var formData = new FormData();

                // Datos de requerimiento
                formData.append('Requerimiento.idRequerimiento', @Model.Requerimiento.idRequerimiento);
                formData.append('Requerimiento.idPersona', $("#kt_cliente_select").val());
                formData.append('Requerimiento.idProyecto', $("#kt_proyecto_cliente_select").val());
                formData.append('Requerimiento.idTipoRequerimiento', $("#kt_tipo_req_select").val());
                formData.append('Requerimiento.codigo', $("#txtCodigo").val());
                formData.append('Requerimiento.solicitante', $("#txtSolicitante").val());
                formData.append('Requerimiento.resumen', $("#txtResumen").val());
                formData.append('Requerimiento.prioridad', $("#kt_prioridad_select").val());
                formData.append('Requerimiento.fechaInicio', $("#kt_datepicker_fecha_ini").val());
                formData.append('Requerimiento.fechaFin', $("#kt_datepicker_fecha_fin").val());
                formData.append('Requerimiento.avanceDesarrollo', $("#txtAvanceDesa").val());
                formData.append('Requerimiento.tiempo', $("#txtTiempo").val());
                formData.append('Requerimiento.idAdicional', $("#kt_adicional").val());
                formData.append('Requerimiento.aprobacion', $("#txtAprobacion").val());
                formData.append('Requerimiento.fechaRegistro', $("#kt_datepicker_fecha").val());
                formData.append('Requerimiento.estadoReq', $("#kt_estado_select").val());

                $('#kt_docs_repeater_basic [data-repeater-item]').each(function (index) {
                var idPersona = $(this).find('.form-select[id^="kt_trabajador_select"]').val();
                var descrip = $(this).find('.form-control[id^="txtDescripcion"]').val();
                var coment = $(this).find('.form-control[id^="txtComentario"]').val();
                var estDesa = $(this).find('.form-select[id^="kt_estado_desa_select"]').val();
                var estCli = $(this).find('.form-select[id^="kt_estado_cliente_select"]').val();
                var fecIni = $(this).find('.form-control[id^="kt_datepicker_fecha_ini_detalle"]').val();
                var fecFin = $(this).find('.form-control[id^="kt_datepicker_fecha_fin_detalle"]').val();
                var modulo = $(this).find('.form-control[id^="txtModulo"]').val();
                var criterioAceptacion = $(this).find('textarea.summernote').summernote('code');


                // Obtener el ID del elemento Dropzone de esta fila
                var dropzoneId = $(this).find('.dropzone').attr('id');

                // Obtener el nombre del archivo en Dropzone de esta fila
                var dropzone = Dropzone.forElement("#" + dropzoneId);
                var files = dropzone.files;

                // Obtener el primer archivo de Dropzone
                var archivo = null;
                if (files.length > 0) {
                    var file = files[0];
                    archivo = new File([file], file.name);
                }

                // Agregar el archivo a la formData
                if (archivo !== null) {
                    formData.append('ListaDetalleRequerimiento[' + index + '].archivo', archivo);
                }

                // Obtener el valor de data-accion del padre (data-repeater-list)
                var accion = $(this).closest('[data-repeater-list]').data('accion');

                // DETALLE REQUERIMIENTO
                formData.append('DetalleRequerimiento.idDetalleRequerimiento',@Model.DetalleRequerimiento.idDetalleRequerimiento);

                // LISTA DETALLE REQUERIMIENTO
                formData.append('ListaDetalleRequerimiento[' + index + '].idPersona', idPersona);
                formData.append('ListaDetalleRequerimiento[' + index + '].descripcion', descrip);
                formData.append('ListaDetalleRequerimiento[' + index + '].comentarioCliente', coment);
                formData.append('ListaDetalleRequerimiento[' + index + '].estadoDesarrollo', estDesa);
                formData.append('ListaDetalleRequerimiento[' + index + '].estadoCliente', estCli);
                formData.append('ListaDetalleRequerimiento[' + index + '].fechaInicio', fecIni);
                formData.append('ListaDetalleRequerimiento[' + index + '].fechaFin', fecFin);
                formData.append('ListaDetalleRequerimiento[' + index + '].modulo', modulo);
                formData.append('ListaDetalleRequerimiento[' + index + '].criterioAceptacion', criterioAceptacion);
                formData.append('ListaDetalleRequerimiento[' + index + '].operacion', accion);

            });

            //console.log("Contenido de formData:");

            //for (let pair of formData.entries()) {
            //    console.log(pair[0] + ": " + pair[1]);
            //}

            $.ajax({
                url: "@Url.Action("Guardar", "Requerimiento")",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    let message = "¡El Requerimiento se ha registrado correctamente!";
                    Swal.fire({
                        text: message,
                        icon: "success",
                        buttonsStyling: false,
                        confirmButtonText: "Listo",
                        customClass: { confirmButton: "btn btn-primary" },
                    }).then(function () {
                        window.location.href = '@Url.Action("Index", "Requerimiento")';
                    });
                },
                error: function (error) {
                    // Mostrar mensaje de error
                    Swal.fire({
                        text: "Se produjo un error al enviar el formulario. Por favor, inténtalo de nuevo.",
                        icon: "error",
                        buttonsStyling: false,
                        confirmButtonText: "Ok",
                        customClass: { confirmButton: "btn btn-primary" },
                    });
                },
            });
        }

        // Función para validar si la tecla presionada es un número
        function validarNumero(event) {
            // Obtener el código de la tecla presionada
            var codigoTecla = event.keyCode || event.which;

            // Permitir los números del 0 al 9 y las teclas de navegación
            if ((codigoTecla >= 48 && codigoTecla <= 57) ||  // Números del teclado alfanumérico
                (codigoTecla >= 96 && codigoTecla <= 105) || // Números del teclado numérico
                codigoTecla == 8 ||  // Tecla de retroceso
                codigoTecla == 9 ||  // Tecla de tabulación
                codigoTecla == 37 || // Flecha izquierda
                codigoTecla == 39 || // Flecha derecha
                codigoTecla == 46 || // Tecla de suprimir
                codigoTecla == 13 || // Tecla de enter
                (event.ctrlKey && (codigoTecla == 67 || codigoTecla == 86))) { // Permitir copiar (Ctrl+C) y pegar (Ctrl+V)
                return true; // Permitir la tecla
            } else {
                event.preventDefault(); // Bloquear la tecla
                return false; // Evitar la entrada de caracteres no deseados
            }
        }
        //funcion para que el tiempo solo permita numeros
        function filtrarNumerosYPuntuacion(input) {
            let valor = input.value;

            // Permitir solo números, punto, punto y coma y dos puntos
            valor = valor.replace(/[^0-9.,:]/g, '');

            input.value = valor;
        }



        // Función para inicializar Dropzone
        function initializeDropzone(counter) {
            var dropzoneId = 'kt_dropzonejs_banner_' + counter;
            var dropzoneElement = document.getElementById(dropzoneId);

            // Asegúrate de que el elemento no se haya inicializado previamente
            if (dropzoneElement && !dropzoneElement.dropzone) {
                var myDropzone = new Dropzone(dropzoneElement, {
                    url: "https://keenthemes.com/scripts/void.php", // Tu URL de carga de imágenes
                    paramName: "file", // Nombre del parámetro que se usará para transferir el archivo
                    maxFiles: 1, // Solo permitir una imagen por contenedor
                    maxFilesize: 10, // Tamaño máximo del archivo en MB
                    addRemoveLinks: true, // Mostrar enlaces para eliminar archivos
                    acceptedFiles: '', // Tipos de archivos aceptados
                    uploadMultiple: false, // No permitir cargar múltiples archivos
                    autoProcessQueue: false, // No procesar automáticamente la cola
                    dictRemoveFile: 'Quitar Archivo', // Texto para quitar la imagen
                    dictMaxFilesExceeded: "No puedes subir más archivos.",
                    dictFileTooBig: "El archivo es demasiado grande.",
                    dictInvalidFileType: "No puedes subir archivos de este tipo."
                });
            }
        }

        $(document).ready(function () {

            $("#kt_datepicker_fecha").flatpickr({
                dateFormat: 'd/m/Y',
                locale: spanishLocale,
                defaultDate: new Date(),
            });

            $("#kt_datepicker_fecha_ini").flatpickr({
                dateFormat: 'd/m/Y',
                locale: spanishLocale,
                defaultDate: new Date(),
            });

            $("#kt_datepicker_fecha_fin").flatpickr({
                dateFormat: 'd/m/Y',
                locale: spanishLocale,
                minDate: "today", // Bloquear fechas anteriores a hoy
                defaultDate: new Date(),
            });            
            
            $('#kt_docs_repeater_basic').repeater({

                initEmpty: false,

                show: function () {

                    var $newItem = $(this).slideDown();
                    counter++;

                    // Reemplaza el placeholder {{counter}} con el valor actual del contador
                    $newItem.html($newItem.html().replace(/{{counter}}/g, counter));

                    // Inicializa select2 y flatpickr en los nuevos elementos
                    $newItem.find('[data-kt-repeater="select2"]').select2();
                    $newItem.find('[data-kt-repeater="datepicker"]').flatpickr({
                        dateFormat: 'd/m/Y',
                        locale: spanishLocale
                    });
                    //para los iconos de comentario
                    $('.summernote').summernote({
                        height: 300,
                        toolbar: [
                            ['style', ['bold', 'italic', 'underline', 'clear']],
                            ['font', ['strikethrough', 'superscript']],
                            ['fontsize', ['fontsize']],
                            ['color', ['color']],
                            ['para', ['ul', 'ol', 'paragraph']],
                            ['height', ['height']],
                            ['insert', ['picture', 'link', 'video']],
                            ['view', ['fullscreen', 'codeview']]
                        ]
                    });

                    // Cambiar fondo de la toolbar a gris claro
                    $('.note-toolbar').css({
                        'background-color': '#d3d3d3',  // gris claro
                        'color': '#000'                 // texto e iconos negros
                    });

                    // Forzar color negro a íconos y textos dentro de la toolbar
                    $('.note-toolbar button, .note-toolbar .note-icon').css('color', '#000');

                    // Fondo blanco para el área editable y texto negro
                    $('.note-editable').css({
                        'background-color': '#fff',
                        'color': '#000'
                    });


                    // Inicializa Dropzone
                    initializeDropzone(counter);
                },

                hide: function (deleteElement) {
                    $(this).slideUp(deleteElement);
                },

                ready: function (setIndexes) {
                    // Recorre todos los items iniciales y reemplaza el placeholder {{counter}}
                    $('[data-repeater-item]').each(function () {
                        counter++;
                        var $item = $(this);
                        $item.html($item.html().replace(/{{counter}}/g, counter));
                    });

                    // Inicializa select2 y flatpickr para los elementos existentes
                    $('[data-kt-repeater="select2"]').select2();
                    $('[data-kt-repeater="datepicker"]').flatpickr({
                        dateFormat: 'd/m/Y',
                        locale: spanishLocale
                    });

                    // Inicializa Dropzone para los elementos existentes
                    $('[data-repeater-item]').each(function () {
                        initializeDropzone(counter);
                    });
                }
            });
            //para los iconos de comentario
            $('.summernote').summernote({
                height: 300,
                toolbar: [
                    ['style', ['bold', 'italic', 'underline', 'clear']],
                    ['font', ['strikethrough', 'superscript']],
                    ['fontsize', ['fontsize']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['height', ['height']],
                    ['insert', ['picture', 'link', 'video']],
                    ['view', ['fullscreen', 'codeview']]
                ]
            });

            // Cambiar fondo de la toolbar a gris claro
            $('.note-toolbar').css({
                'background-color': '#d3d3d3',  // gris claro
                'color': '#000'                 // texto e iconos negros
            });

            // Forzar color negro a íconos y textos dentro de la toolbar
            $('.note-toolbar button, .note-toolbar .note-icon').css('color', '#000');

            // Fondo blanco para el área editable y texto negro
            $('.note-editable').css({
                'background-color': '#fff',
                'color': '#000'
            });

            // Inicializar Dropzone para la fila existente al cargar la página
            initializeDropzone(counter);

        });

        $(document).on('click', '[data-repeater-delete]', function () {
            // Obtener el nombre del archivo a eliminar
            var fileName = $(this).closest('[data-repeater-item]').find('.dz-filename').text().trim();

            // Buscar el archivo en la lista de documentos
            var fileToRemoveIndex = -1;

            ListaDocumentosFile.forEach(function (file, index) {
                if (file.name === fileName) {
                    fileToRemoveIndex = index;
                }
            });

            // Si se encontró el archivo en la lista
            if (fileToRemoveIndex !== -1) {
                // Eliminar el archivo de la lista
                ListaDocumentosFile.splice(fileToRemoveIndex, 1);

                console.log("Archivo eliminado de la lista: " + fileName);
            } else {
                console.log("No se encontró el archivo en la lista: " + fileName);
            }
        });

    </script>
}
