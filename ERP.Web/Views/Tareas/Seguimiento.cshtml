@model Mantenimiento.Negocio.Poco.GestionarTareaPoco
@{
    Layout = "~/Views/Shared/_Layout2.cshtml";
}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f7fb;
        margin: 0;
        padding: 20px;
    }

    h2 {
        margin-top: 0;
        color: #333;
    }

    .panel-filtros {
        background: #ffffff;
        border: 1px solid #dcdfe6;
        border-radius: 6px;
        padding: 10px 12px;
        margin-bottom: 10px;
    }

        .panel-filtros label {
            font-size: 13px;
            color: #555;
            margin-right: 4px;
        }

        .panel-filtros input,
        .panel-filtros select {
            font-size: 13px;
            padding: 4px 6px;
            margin-right: 8px;
        }

    .btn {
        font-size: 13px;
        padding: 5px 10px;
        border-radius: 4px;
        border: 1px solid #409eff;
        background: #409eff;
        color: #fff;
        cursor: pointer;
    }

        .btn:hover {
            background: #66b1ff;
        }

    .resumen-global {
        background: #ffffff;
        border: 1px solid #dcdfe6;
        border-radius: 6px;
        padding: 8px 12px;
        margin-bottom: 10px;
        font-size: 13px;
    }

    .badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 11px;
        color: #fff;
    }

    .badge-total {
        background: #909399;
    }

    .badge-pendiente {
        background: #f56c6c;
    }

    .badge-proceso {
        background: #e6a23c;
    }

    .badge-ok {
        background: #67c23a;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        background: #ffffff;
        border-radius: 6px;
        overflow: hidden;
        font-size: 13px;
    }

    thead {
        background: #f2f6fc;
    }

        thead th {
            border-bottom: 1px solid #dcdfe6;
            padding: 6px 8px;
            text-align: left;
            color: #606266;
            white-space: nowrap;
        }

    tbody td {
        border-bottom: 1px solid #ebeef5;
        padding: 5px 8px;
        color: #606266;
    }

    tbody tr:nth-child(even) {
        background: #fafafa;
    }

    tbody tr:hover {
        background: #f5f7fa;
    }

    .fila-grupo {
        background: #e9f3ff !important;
        font-weight: bold;
    }

        .fila-grupo td {
            border-bottom: 1px solid #c6e2ff;
        }

    .estado-pill {
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 11px;
        color: #fff;
    }

    .estado-pendiente {
        background: #f56c6c;
    }

    .estado-proceso {
        background: #e6a23c;
    }

    .estado-completada {
        background: #67c23a;
    }

    .sin-datos {
        text-align: center;
        color: #999;
        padding: 10px 0;
    }


    .btn-accion {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        color: white;
        font-size: 12px;
    }

    .btn-accion.iniciar {
        background-color: #007bff;
    }

    .btn-accion.finalizar {
        background-color: #28a745;
    }

    .sin-accion {
        color: #888;
    }


</style>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Actividades agrupadas por proyecto</title>

</head>
<body>

    <h2>Actividades agrupadas por proyecto</h2>

    <!-- ================= FILTROS ================= -->
    <div class="panel-filtros">
        <label>Buscar:</label>
        <input type="text" id="filtroTexto" placeholder="Cliente, Req, Actividad..." onkeyup="actualizar()" />

        <label>Proyecto:</label>
        <select id="filtroProyecto" onchange="actualizar()">
            <option value="" data-id="0">-- Todos --</option>
            @foreach (var a in Model.ListarProyectos)
            {
                <option value="@a.nombre" data-id="@a.idProyecto">@a.nombre</option>
            }
        </select>

        <label>Estado:</label>
        <select id="filtroEstado" onchange="actualizar()">
            <option value="">-- Todos --</option>
            <option value="Pendiente" data-id="1">Pendiente</option>
            <option value="En proceso" data-id="2">En proceso</option>
            <option value="Completada" data-id="3">Completada</option>
        </select>

        <label>Responsable:</label>
        <select id="filtroResponsable" onchange="actualizar()">
            <option value="" data-id="0">-- Todos --</option>
            @foreach (var a in Model.ListarPersonaResponsable)
            {
                var responsable = a.nombres + " " + a.apellidoPaterno + " " + a.apellidoMaterno;
                <option value="@responsable" data-id="@a.idPersona">@responsable</option>
            }
        </select>

        <button class="btn" onclick="actualizar()"> Actualizar</button>
    </div>

    <!-- =============== TOTALIZADORES GLOBALES =============== -->
    <div class="resumen-global" id="resumenGlobal">
        <!-- Se llena desde JS -->
    </div>

    <!-- ================= TABLA GENERAL ================= -->
    <table>
        <thead>
            <tr>
                <th>Proyecto</th>
                <th>Requerimiento</th>
                <th>Tipo</th>
                <th>Cliente</th>
                <th>Actividad</th>
                <th>Responsable</th>
                <th>Fecha inicio</th>
                <th>Fecha fin</th>
                <th>Estado</th>
                <th>Accion</th>
            </tr>
        </thead>
        <tbody id="tbodyGeneral"></tbody>
    </table>
    
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">EDITAR REQUERIMIENTO DETALLE</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-5 gx-1">
                        <label class="form-label required fw-bold">DESCRIPCIÓN:</label>
                        <textarea type="text" class="form-control" id="txtDescripcion" placeholder="Ingrese descripción" style="height: 70px;"
                                  maxlength="300"></textarea>
                    </div>
                    <div class="row mb-5 gx-1">
                        <div class="col-md-6 mb-4">
                            <label class="form-label fw-bold">ESTADO DESARROLLO:</label>
                            <!--begin::Select-->
                            <input type="hidden" id="txtIdDetallerequerimiento" />
                            <select class="form-select" data-control="select2" id="idDesarrollo" style="font-size: 11px;">
                                <option value="-1">Seleccione estado desarrollo</option>
                                <option value="1">PENDIENTE</option>
                                <option value="2">EN PROCESO</option>
                                <option value="3">FINALIZADO</option>
                            </select>
                            <!--end::Select-->
                        </div>
                        <div class="col-md-6 mb-4">
                            <label class="form-label fw-bold">ASIGNADO A:</label>
                            <select class="form-select" data-control="select2" id="idAsignado" style="font-size: 11px;">
                                <!-- Opción por defecto -->
                                <option value="">Seleccione Trabajador</option>
                                @if (Model.ListarTrabajadores.Any())
                                {
                                    foreach (var item in Model.ListarTrabajadores)
                                    {
                                        <option value="@item.idPersona">@item.nombreCli</option>
                                    }
                                }
                                else
                                {
                                    // Si no hay trabajadores disponibles, mostrar una opción por defecto
                                    <option value="">No existen trabajadores</option>
                                }
                            </select>
                        </div>

                    </div>
                    <div class="row mb-5 gx-5">
                        <div class="col-md-6 mb-4">
                            <!--begin::Input group-->
                            <!--begin::Label-->
                            <label class="form-label fw-bold"
                                   for="kt_datepicker_fecha_ini_detalle">FECHA INICIO:</label>
                            <!--end::Label-->
                            <!--begin::Input-->
                            <input type="text"
                                   id="kt_datepicker_fecha_ini_detalle"
                                   class="form-control"
                                   data-kt-repeater="datepicker"
                                   placeholder="Fecha incio detalle" />
                            <!--end::Input-->
                            <!--end::Input group-->
                        </div>
                        <div class="col-md-6 mb-4">
                            <!--begin::Input group-->
                            <!--begin::Label-->
                            <label class="form-label fw-bold"
                                   for="kt_datepicker_fecha_fin_detalle">FECHA FIN:</label>
                            <!--end::Label-->
                            <!--begin::Input-->
                            <input type="text"
                                   id="kt_datepicker_fecha_fin_detalle"
                                   class="form-control"
                                   data-kt-repeater="datepicker"
                                   placeholder="Fecha fin detalle" />
                            <!--end::Input-->
                            <!--end::Input group-->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="btnEditarDetalle">Editar Requerimiento</button>
                </div>
            </div>
        </div>
    </div>




    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>


        let actividades = [];

        // =========================================
        // CARGA INICIAL COMBOS DE FILTROS
        // =========================================
       
        // =========================================
        // BOTÓN ACTUALIZAR (simulación)
        // =========================================
        function actualizar() {

            const idProyecto = $("#filtroProyecto option:selected").attr("data-id") || 0;
            const idEstado = $("#filtroEstado option:selected").attr("data-id") || 0;
            const idResponsable = $("#filtroResponsable option:selected").attr("data-id") || 0;
            $.ajax({
                url: "/Tareas/ListarSeguimientoTareas",
                type: "GET",
                data: {
                    idProyecto: idProyecto,
                    idEstado: idEstado,
                    idResponsable: idResponsable
                },

                success: function (data) {

                    // Reemplazar la lista de actividades con la del servidor
                    actividades = data.map(x => ({
                        proyecto: x.proyecto,
                        idProyecto: x.idProyecto,
                        requerimiento: x.requerimiento,
                        idRequerimiento: x.idRequerimiento,
                        cliente: x.cliente,
                        actividad: x.actividad,
                        inicio: x.fechaInicio,
                        fin: x.fechaFin,
                        estado: x.estado,
                        idResponsable: x.idResponsable,
                        tipoRequerimiento: x.tipoRequerimiento,
                        responsable: x.responsable,
                        id: x.idDetalleRequerimiento,                      // IMPORTANTE si usas ID
                        estadoDesarrollo: x.estadoDesarrollo // Para el botón iniciar/finalizar
                    }));

                    // Volver a renderizar la vista
                    render();
                }
            });

        }
        function convertirFechaNET(fechaNET) {
            if (!fechaNET) return null;
            const timestamp = parseInt(fechaNET.replace("/Date(", "").replace(")/", ""));
            return new Date(timestamp);
        }

        function abrirModalDetalle(id) {
            $.ajax({
                url: "/Tareas/ObtenerRequerimientoDetalle",
                type: "GET",
                data: {
                    idDetalleRequerimiento: id
                },
                success: function (data) {
                    $("#txtIdDetallerequerimiento").val(id);
                    $("#txtDescripcion").val(data.descripcion);

                    // Select Estado Desarrollo
                    $("#idDesarrollo").val(data.estadoDesarrollo).trigger('change');

                    // Select Asignado A
                    $("#idAsignado").val(data.idPersona).trigger('change');

                    // --- FECHAS ---
                    const fechaInicio = convertirFechaNET(data.fechaInicio);
                    const fechaFin = convertirFechaNET(data.fechaFin);

                    if (fechaInicio)
                        fpInicio.setDate(fechaInicio);
                    else
                        fpInicio.clear();

                    if (fechaFin)
                        fpFin.setDate(fechaFin);
                    else
                        fpFin.clear();

                    $("#exampleModal").modal("show")
                    
                }
            });
           
        }


        function abrirDetalle(id) {
            window.location.href = "/Requerimiento/Editar?id=" + id;
        }

        // =========================================
        // RENDERIZAR TABLA AGRUPADA POR PROYECTO
        // =========================================
        function render() {
            const tbody = document.getElementById("tbodyGeneral");
            const resumen = document.getElementById("resumenGlobal");
            tbody.innerHTML = "";

            const text = document.getElementById("filtroTexto").value.toLowerCase();
            const filtroProyecto = document.getElementById("filtroProyecto").value;
            const filtroEstado = document.getElementById("filtroEstado").value;
            const filtroResp = document.getElementById("filtroResponsable").value;


            console.log(actividades)
            // FILTRADO GENERAL
            let lista = actividades.filter(a =>
                (!filtroProyecto || a.proyecto === filtroProyecto) &&
                (!filtroEstado || a.estado === filtroEstado) &&
                (!filtroResp || a.responsable === filtroResp) &&
                (
                    a.actividad.toLowerCase().includes(text) ||
                    a.cliente.toLowerCase().includes(text) ||
                    a.requerimiento.toLowerCase().includes(text)
                )
            );

            // TOTALIZADORES GLOBALES
            const total = lista.length;
            const pend = lista.filter(a => a.estado.toLowerCase() === "pendiente").length;
            const proc = lista.filter(a => a.estado.toLowerCase() === "en proceso").length;
            const comp = lista.filter(a => a.estado.toLowerCase() === "completada").length;

            resumen.innerHTML = `
                <strong>Resumen filtrado:</strong>
                &nbsp;
                <span class="badge badge-total">Total: ${total}</span>
                &nbsp;
                <span class="badge badge-pendiente">Pendientes: ${pend}</span>
                &nbsp;
                <span class="badge badge-proceso">En proceso: ${proc}</span>
                &nbsp;
                <span class="badge badge-ok">Completadas: ${comp}</span>
            `;

            if (lista.length === 0) {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td colspan="8" class="sin-datos">No hay actividades para el filtro seleccionado.</td>`;
                tbody.appendChild(tr);
                return;
            }

            // AGRUPAR POR PROYECTO
            const grupos = {};
            lista.forEach(a => {
                if (!grupos[a.proyecto]) grupos[a.proyecto] = [];
                grupos[a.proyecto].push(a);
            });

            // PINTAR EN UNA SOLA TABLA
            for (const proyecto in grupos) {
                const actividadesProyecto = grupos[proyecto];

                // Totalizadores por proyecto
                const tTotal = actividadesProyecto.length;
                const tPend = actividadesProyecto.filter(a => a.estado.toLowerCase() === "pendiente").length;
                const tProc = actividadesProyecto.filter(a => a.estado.toLowerCase() === "en proceso").length;
                const tComp = actividadesProyecto.filter(a => a.estado.toLowerCase() === "completada").length;

                // ROW DE AGRUPACIÓN
                const trGrupo = document.createElement("tr");
                trGrupo.className = "fila-grupo";
                trGrupo.innerHTML = `
                    <td colspan="10">
                        📁 <strong>${proyecto}</strong>
                        &nbsp;&nbsp;
                        <span class="badge badge-total">Total: ${tTotal}</span>
                        &nbsp;
                        <span class="badge badge-pendiente">Pend: ${tPend}</span>
                        &nbsp;
                        <span class="badge badge-proceso">Proc: ${tProc}</span>
                        &nbsp;
                        <span class="badge badge-ok">Comp: ${tComp}</span>
                    </td>
                `;
                tbody.appendChild(trGrupo);

                // LISTA DE ACTIVIDADES DE ESE PROYECTO
                actividadesProyecto.forEach(a => {
                    const tr = document.createElement("tr");

                    let claseEstado = "";
                    const estLower = a.estado.toLowerCase();
                    if (estLower === "pendiente") claseEstado = "estado-pendiente";
                    else if (estLower === "en proceso") claseEstado = "estado-proceso";
                    else if (estLower === "completada") claseEstado = "estado-completada";

                    // AGREGACION DE BOTON DE EDICION DE ESTADO DEL DETALLE
                    let botonAccion = "";
                    if (a.estadoDesarrollo === 1 || a.estadoDesarrollo === 2) {
                        botonAccion = `<button class="btn-accion iniciar" data-id="${a.id}"><span class="fa-solid fa-play"></span></button>`;
                    }else {
                        botonAccion = `<span class="sin-accion"></span>`; // Sin botón
                    }

                    tr.innerHTML = `
                        <td>${a.proyecto}</td>
                        <td>
                            <a href="#" class="link-req" data-id="${a.idRequerimiento}">
                                ${a.requerimiento}
                            </a>
                        </td>
                        <td>${a.tipoRequerimiento}</td>
                        <td>${a.cliente}</td>
                        <td>${a.actividad}</td>
                        <td>${a.responsable}</td>
                        <td>${a.inicio}</td>
                        <td>${a.fin}</td>
                        <td><span class="estado-pill ${claseEstado}">${a.estado}</span></td>
                        <td>${botonAccion}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }
        //document.addEventListener("click", e => {
        //    if (e.target.classList.contains("iniciar")) {
        //        const id = e.target.dataset.id;
        //        console.log("Iniciar tarea:", id);
        //        abrirModalDetalle(id);
        //    }
        //});
        document.addEventListener("click", e => {
            const boton = e.target.closest(".iniciar");
            if (boton) {
                // marcar botón como activo
                document.querySelectorAll(".iniciar").forEach(b => b.classList.remove("activo"));
                boton.classList.add("activo");

                const id = boton.dataset.id;
                abrirModalDetalle(id);
            }
        });

        document.addEventListener("click", function (e) {

            if (e.target.classList.contains("link-req")) {
                e.preventDefault();

                const id = e.target.dataset.id;
                abrirDetalle(id);
            }

        });
        let fpInicio, fpFin;
        $(document).ready(() => {
            fpInicio = $("#kt_datepicker_fecha_ini_detalle").flatpickr({
                dateFormat: 'd/m/Y',
                locale: spanishLocale,
                allowInput: true
            });

            fpFin = $("#kt_datepicker_fecha_fin_detalle").flatpickr({
                dateFormat: 'd/m/Y',
                locale: spanishLocale,
                allowInput: true
            });
        })
        $("#btnEditarDetalle").on("click", function () {

            var formData = new FormData();

            formData.append("requerimientoDetalle.idDetalleRequerimiento", $("#txtIdDetallerequerimiento").val());
            formData.append("requerimientoDetalle.descripcion", $("#txtDescripcion").val());
            formData.append("requerimientoDetalle.estadoDesarrollo", $("#idDesarrollo").val());
            formData.append("requerimientoDetalle.idPersona", $("#idAsignado").val());
            formData.append("requerimientoDetalle.fechaInicio", $("#kt_datepicker_fecha_ini_detalle").val());
            formData.append("requerimientoDetalle.fechaFin", $("#kt_datepicker_fecha_fin_detalle").val());

            $.ajax({
                url: '/Tareas/EditarDetalle',   // cambia por tu ruta real
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    if (response.idResultado == 1) {
                        Swal.fire({
                            title: response.mensaje,
                            icon: "success",
                            showConfirmButton: false,
                            timer: 1200,
                            text: ""     // evita mostrar texto vacío en pantalla
                        });

                       //Swal.fire("Correcto", "Detalle actualizado", "success");
                        actualizar();
                        $("#exampleModal").modal("hide");
                    }
                    else {
                        Swal.fire("Error", response.message, "error");
                    }
                },
                error: function () {
                    Swal.fire("Error", "Ocurrió un problema con el servidor", "error");
                }
            });
        });

        // =====================
        // CARGAR TODO AL INICIO
        // =====================
        actualizar()
        //cargarFiltros();
        //render();

    </script>

</body>
</html>
