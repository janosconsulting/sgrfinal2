@model Mantenimiento.Negocio.Poco.GestionarDocumentoOrigenPoco
@{
    Layout = "~/Views/Shared/_Layout2.cshtml";
    var isEdit = Model != null && Model.IsEditing && Model.DocumentoOrigen != null && Model.DocumentoOrigen.idAdicional > 0;
}

<style>
    .card-soft {
        border: 1px solid #eef0f4;
        box-shadow: 0 10px 30px rgba(0,0,0,.04);
        border-radius: 14px;
    }

    .section-title {
        font-weight: 800;
        letter-spacing: .2px;
        background: #f6f8fb;
        border: 1px solid #e8edf5;
        border-radius: 10px;
        padding: 10px 12px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .section-title i {
            font-size: 18px;
        }

    .form-hint {
        font-size: 12px;
        color: #7a8699;
        margin-top: 6px;
    }

    .req {
        color: #d9214e;
        font-weight: 800;
    }

    .control-sm {
        min-height: 44px;
        border-radius: 10px;
    }

    .sticky-actions {
        position: sticky;
        bottom: 16px;
        z-index: 10;
        background: rgba(255,255,255,.92);
        backdrop-filter: blur(8px);
        border: 1px solid #eef0f4;
        border-radius: 14px;
        padding: 12px;
        box-shadow: 0 12px 28px rgba(0,0,0,.06);
    }
</style>

<div class="d-flex flex-column flex-column-fluid">
    <!-- Toolbar -->
    <div id="kt_app_toolbar" class="app-toolbar pt-7 pt-lg-10">
        <div id="kt_app_toolbar_container" class="app-container container-fluid d-flex align-items-stretch">
            <div class="app-toolbar-wrapper d-flex flex-stack flex-wrap gap-4 w-100">
                <div class="page-title d-flex flex-column justify-content-center gap-1 me-3">
                    <h1 class="page-heading d-flex flex-column justify-content-center text-dark fw-bold fs-3 m-0">
                        @(isEdit ? "Editar Documento de Origen" : "Nuevo Documento de Origen")
                    </h1>
                    <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0">
                        <li class="breadcrumb-item text-muted">
                            <a href="@Url.Action("Index","Dashboard")" class="text-muted text-hover-primary">Home</a>
                        </li>
                        <li class="breadcrumb-item"><span class="bullet bg-gray-400 w-5px h-2px"></span></li>
                        <li class="breadcrumb-item text-muted">Procesos</li>
                        <li class="breadcrumb-item"><span class="bullet bg-gray-400 w-5px h-2px"></span></li>
                        <li class="breadcrumb-item text-muted">
                            <a href="@Url.Action("Index","DocumentoOrigen")" class="text-muted text-hover-primary">Documentos de Origen</a>
                        </li>
                        <li class="breadcrumb-item"><span class="bullet bg-gray-400 w-5px h-2px"></span></li>
                        <li class="breadcrumb-item text-muted">@(isEdit ? "Editar" : "Nuevo")</li>
                    </ul>
                </div>

                <div class="d-flex align-items-center gap-2">
                    <a href="@Url.Action("Index","DocumentoOrigen")" class="btn btn-light">
                        <i class="las la-arrow-left fs-3"></i> Volver
                    </a>

                    @if (isEdit)
                    {
                        <a target="_blank" href="@Url.Action("Checklist","DocumentoOrigen", new { id = Model.DocumentoOrigen.idAdicional })" class="btn btn-light-primary">
                            <i class="las la-print fs-3"></i> Checklist
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div id="kt_app_content" class="app-content flex-column-fluid">
        <div id="kt_app_content_container" class="app-container container-fluid">

            <div class="card card-flush card-soft">
                <div class="card-body p-6 p-lg-8">

                    <div class="section-title mb-4">
                        <i class="las la-file-alt"></i>
                        Datos del Documento
                    </div>

                    <input type="hidden" id="idDocumentoOrigen" value="@(Model.DocumentoOrigen.idAdicional)" />

                    <div class="row g-4">
                        <div class="col-lg-3">
                            <label class="form-label fw-bold">Código</label>
                            <input type="text" id="codigo" class="form-control form-control-solid control-sm"
                                   value="@(Model.DocumentoOrigen.codigo)"
                                   placeholder="Se genera automático" readonly />
                            <div class="form-hint">Se asigna automáticamente al guardar.</div>
                        </div>

                        <div class="col-lg-3">
                            <label class="form-label fw-bold">Fecha documento <span class="req">*</span></label>
                            <input type="date" id="fechaDocumento" class="form-control control-sm"
                                   value="@(Model.DocumentoOrigen.fechaRecepcion.ToString("yyyy-MM-dd"))" />
                        </div>

                        <div class="col-lg-3">
                            <label class="form-label fw-bold">Tipo documento <span class="req">*</span></label>
                            <select id="tipoDoc" class="form-select control-sm" data-control="select2" data-placeholder="Seleccione...">
                                <option value=""></option>
                                <option value="1" @(Model.DocumentoOrigen.tipoDoc == 1 ? "selected" : "")>ACTA</option>
                                <option value="2" @(Model.DocumentoOrigen.tipoDoc == 2 ? "selected" : "")>COTIZACIÓN</option>
                                <option value="3" @(Model.DocumentoOrigen.tipoDoc == 3 ? "selected" : "")>DOCUMENTO</option>
                                <option value="4" @(Model.DocumentoOrigen.tipoDoc == 4 ? "selected" : "")>CORREO</option>
                                <option value="5" @(Model.DocumentoOrigen.tipoDoc == 5 ? "selected" : "")>WHATSAPP</option>
                            </select>
                        </div>

                        <div class="col-lg-3">
                            <label class="form-label fw-bold">Estado <span class="req">*</span></label>
                            <select id="estado" class="form-select control-sm" data-control="select2" data-placeholder="Seleccione...">
                                <option value=""></option>
                                <option value="1" @(Model.DocumentoOrigen.estado == 1 ? "selected" : "")>REGISTRADO</option>
                                <option value="2" @(Model.DocumentoOrigen.estado == 2 ? "selected" : "")>EN REVISIÓN</option>
                                <option value="3" @(Model.DocumentoOrigen.estado == 3 ? "selected" : "")>CERRADO</option>
                            </select>
                        </div>

                        <div class="col-lg-6">
                            <label class="form-label fw-bold">Cliente</label>
                            <select id="idCliente" class="form-select control-sm" data-control="select2" data-placeholder="Seleccione cliente...">
                                <option value=""></option>
                                @if (Model.ListarClientes.Any() == true)
                                {
                                    foreach (var c in Model.ListarClientes)
                                    {
                                        <option value="@c.idPersona" @(Model.DocumentoOrigen.idCliente == c.idPersona ? "selected" : "")>@c.nombreCli</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-lg-6">
                            <label class="form-label fw-bold">Proyecto</label>
                            <select id="idProyecto" class="form-select control-sm" data-control="select2" data-placeholder="Seleccione proyecto...">
                                <option value=""></option>
                                @if (Model.ListarProyectos.Any() == true)
                                {
                                    foreach (var p in Model.ListarProyectos)
                                    {
                                        <option value="@p.idProyecto" @(Model.DocumentoOrigen.idProyecto == p.idProyecto ? "selected" : "")>@p.nombre</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">Título / Asunto <span class="req">*</span></label>
                            <input type="text" id="titulo" class="form-control control-sm"
                                   value="@(Model.DocumentoOrigen.nombre ?? "")"
                                   placeholder="Ej: Solicitud de mejoras módulo Requerimientos" />
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">Descripción / Detalle</label>
                            <textarea id="descripcion" rows="4" class="form-control"
                                      placeholder="Resumen del documento, alcance, observaciones...">@(Model.DocumentoOrigen.descripcion)</textarea>
                            <div class="form-hint">Tip: pega aquí lo relevante del Word/correo/WhatsApp para trazabilidad.</div>
                        </div>
                    </div>

                    <!-- Acciones sticky -->
                    <div class="sticky-actions mt-6 d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div class="text-muted fs-7">
                            <i class="las la-info-circle"></i>
                            Guarda el documento para luego generar requerimientos y el checklist imprimible.
                        </div>
                        <div class="d-flex gap-2">
                            <a href="@Url.Action("Index","DocumentoOrigen")" class="btn btn-light">Cancelar</a>
                            <button type="button" class="btn btn-primary" onclick="GuardarDocumentoOrigen();">
                                <i class="las la-save fs-3"></i> Guardar
                            </button>
                        </div>
                    </div>

                </div>
            </div>

            @if (isEdit)
            {
                <div class="card card-flush card-soft mt-5">
                    <div class="card-body p-6 p-lg-8">
                        <div class="section-title mb-3">
                            <i class="las la-tasks"></i>
                            Acciones rápidas
                        </div>

                        <div class="d-flex flex-wrap gap-3">
                            <a class="btn btn-light-success" href="@Url.Action("Nuevo","Requerimiento", new { idDocumentoOrigen = Model.DocumentoOrigen.idAdicional })">
                                <i class="las la-plus-circle fs-3"></i> Crear Requerimientos desde este documento
                            </a>
                            <a class="btn btn-light-primary" target="_blank" href="@Url.Action("Checklist","DocumentoOrigen", new { id = Model.DocumentoOrigen.idAdicional })">
                                <i class="las la-print fs-3"></i> Ver / Imprimir Checklist
                            </a>
                        </div>
                    </div>
                </div>
            }

        </div>
    </div>
</div>

@section Scripts {
    <script>
    function GuardarDocumentoOrigen() {
        var model = {
            DocumentoOrigen: {
                idDocumentoOrigen: parseInt($('#idDocumentoOrigen').val() || '0'),
                // codigo se genera en servidor (SP), pero si ya existe en edición queda
                codigo: $('#codigo').val(),
                idCliente: $('#idCliente').val() ? parseInt($('#idCliente').val()) : null,
                idProyecto: $('#idProyecto').val() ? parseInt($('#idProyecto').val()) : null,
                tipoDoc: $('#tipoDoc').val() ? parseInt($('#tipoDoc').val()) : 0,
                fechaDocumento: $('#fechaDocumento').val(),
                nombre: $('#titulo').val(),
                descripcion: $('#descripcion').val(),
                estado: $('#estado').val() ? parseInt($('#estado').val()) : 0
            }
        };

        // Validaciones básicas
        if (!model.DocumentoOrigen.fechaDocumento) { Swal.fire("Falta fecha", "Seleccione la fecha del documento.", "warning"); return; }
        if (!model.DocumentoOrigen.tipoDoc) { Swal.fire("Falta tipo", "Seleccione el tipo de documento.", "warning"); return; }
        if (!model.DocumentoOrigen.estado) { Swal.fire("Falta estado", "Seleccione el estado.", "warning"); return; }
       
        $.ajax({
            type: "POST",
            url: "@Url.Action("Guardar", "DocumentoOrigen")",
            data: model,
            success: function (res) {
                if (res && res.idResultado == 1) {
                    Swal.fire({
                        text: res.mensaje || "Guardado correctamente.",
                        icon: "success",
                        buttonsStyling: false,
                        confirmButtonText: "Ok",
                        customClass: { confirmButton: "btn fw-bold btn-primary" }
                    }).then(function () {
                        window.location.href = "@Url.Action("Index","DocumentoOrigen")";
                    });
                } else {
                    Swal.fire({
                        text: (res && res.mensaje) ? res.mensaje : "No se pudo guardar.",
                        icon: "error",
                        buttonsStyling: false,
                        confirmButtonText: "Ok",
                        customClass: { confirmButton: "btn fw-bold btn-primary" }
                    });
                }
            },
            error: function (xhr) {
                Swal.fire({
                    text: "Error: " + (xhr.responseText || ""),
                    icon: "error",
                    buttonsStyling: false,
                    confirmButtonText: "Ok",
                    customClass: { confirmButton: "btn fw-bold btn-primary" }
                });
            }
        });
    }
    </script>
}
