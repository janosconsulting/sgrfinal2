@model Mantenimiento.Negocio.Poco.GestionarDocumentoOrigenPoco
@{
    Layout = "~/Views/Shared/_Layout2.cshtml";
}

<style>
    .badge-custom-blue {
        background-color: #007bff;
        color: #fff;
        padding: .25em .5em;
        border-radius: .25rem;
    }

    .badge-custom-purple {
        background: #6f42c1;
        color: #fff;
        padding: .25em .5em;
        border-radius: .25rem;
    }

    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

<div class="d-flex flex-column flex-column-fluid">
    <div id="kt_app_toolbar" class="app-toolbar pt-7 pt-lg-10">
        <div id="kt_app_toolbar_container" class="app-container container-fluid d-flex align-items-stretch">
            <div class="app-toolbar-wrapper d-flex flex-stack flex-wrap gap-4 w-100">
                <div class="page-title d-flex flex-column justify-content-center gap-1 me-3">
                    <h1 class="page-heading d-flex flex-column justify-content-center text-dark fw-bold fs-3 m-0">Documentos de Origen</h1>
                    <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0">
                        <li class="breadcrumb-item text-muted">
                            <a href="@Url.Action("Index","Dashboard")" class="text-muted text-hover-primary">Home</a>
                        </li>
                        <li class="breadcrumb-item"><span class="bullet bg-gray-400 w-5px h-2px"></span></li>
                        <li class="breadcrumb-item text-muted">Procesos</li>
                        <li class="breadcrumb-item"><span class="bullet bg-gray-400 w-5px h-2px"></span></li>
                        <li class="breadcrumb-item text-muted">Gestión de Documentos de Origen</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="kt_app_content" class="app-content flex-column-fluid">
        <div id="kt_app_content_container" class="app-container container-fluid">

            <div class="card card-flush">
                <div class="card-header align-items-center py-5 gap-2 gap-md-5">

                    <div class="card-title">
                        <div class="d-flex align-items-center position-relative my-1">
                            <span class="svg-icon svg-icon-1 position-absolute ms-4">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect opacity="0.5" x="17.0365" y="15.1223" width="8.15546" height="2" rx="1" transform="rotate(45 17.0365 15.1223)" fill="currentColor" />
                                    <path d="M11 19C6.55556 19 3 15.4444 3 11C3 6.55556 6.55556 3 11 3C15.4444 3 19 6.55556 19 11C19 15.4444 15.4444 19 11 19ZM11 5C7.53333 5 5 7.53333 5 11C5 14.4667 7.53333 17 11 17C14.4667 17 17 14.4667 17 11C17 7.53333 14.4667 5 11 5Z" fill="currentColor" />
                                </svg>
                            </span>
                            <input type="text" data-kt-datatable-docorigen-filter="search"
                                   class="form-control form-control-solid w-250px ps-14" placeholder="Buscar documento..." />
                        </div>
                    </div>

                    <div class="card-toolbar flex-row-fluid justify-content-end gap-5">
                        <button type="button" class="btn btn-light-success me-3" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
                            <i class="las la-filter fs-2"></i>Filtrar
                        </button>

                        <div class="menu menu-sub menu-sub-dropdown w-360px w-md-400px" data-kt-menu="true">
                            <div class="px-7 py-5">
                                <div class="fs-5 text-gray-900 fw-bold">Opciones de filtrado</div>
                            </div>
                            <div class="separator border-gray-200"></div>

                            <div class="px-7 py-5">
                                <div class="mb-10">
                                    <label class="form-label fs-6 fw-semibold" for="kt_doc_cliente_select">Cliente:</label>
                                    <select id="kt_doc_cliente_select" class="form-select" data-control="select2">
                                        <option value="">Todos</option>
                                        @if (Model.ListarClientes.Any() == true)
                                        {
                                            foreach (var c in Model.ListarClientes)
                                            {
                                                <option value="@c.idPersona">@c.nombreCli</option>
                                            }
                                        }
                                    </select>
                                </div>

                                <div class="mb-10">
                                    <label class="form-label fs-6 fw-semibold" for="kt_doc_proyecto_select">Proyecto:</label>
                                    <select id="kt_doc_proyecto_select" class="form-select" data-control="select2">
                                        <option value="">Todos</option>
                                        @if (Model.ListarProyectos.Any() == true)
                                        {
                                            foreach (var p in Model.ListarProyectos)
                                            {
                                                <option value="@p.idProyecto">@p.nombre</option>
                                            }
                                        }
                                    </select>
                                </div>

                                <div class="mb-10">
                                    <label class="form-label fs-6 fw-semibold" for="kt_doc_tipo_select">Tipo documento:</label>
                                    <select id="kt_doc_tipo_select" class="form-select" data-control="select2">
                                        <option value="">Todos</option>
                                        <option value="1">ACTA</option>
                                        <option value="2">COTIZACIÓN</option>
                                        <option value="3">DOCUMENTO</option>
                                        <option value="4">CORREO</option>
                                        <option value="5">WHATSAPP</option>
                                    </select>
                                </div>

                                <div class="mb-10">
                                    <label class="form-label fs-6 fw-semibold" for="kt_doc_estado_select">Estado:</label>
                                    <select id="kt_doc_estado_select" class="form-select" data-control="select2">
                                        <option value="">Todos</option>
                                        <option value="1">REGISTRADO</option>
                                        <option value="2">EN REVISIÓN</option>
                                        <option value="3">CERRADO</option>
                                    </select>
                                </div>

                                <div class="d-flex justify-content-end">
                                    <button type="reset" class="btn btn-light btn-active-light-primary fw-semibold me-2 px-6"
                                            data-kt-menu-dismiss="true" onclick="ResetDoc();">
                                        Cancelar
                                    </button>
                                    <button type="button" class="btn btn-success fw-semibold px-6"
                                            data-kt-menu-dismiss="true" onclick="FiltrarDoc();">
                                        Aplicar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <a href="@Url.Action("Nuevo","DocumentoOrigen")" class="btn btn-primary">Nuevo</a>
                    </div>
                </div>

                <div class="card-body pt-0">
                    <table id="kt_datatable_docorigen" class="table align-middle table-row-dashed fs-6 gy-5">
                        <thead>
                            <tr class="text-center text-gray-400 fw-bold fs-7 text-uppercase gs-0">
                                <th>Id</th>
                                <th>Código</th>
                                <th>Tipo</th>
                                <th>Cliente</th>
                                <th>Proyecto</th>
                                <th>Fecha Doc.</th>
                                <th>Título / Asunto</th>
                                <th>Estado</th>
                                <th>Req.</th>
                                <th>Checklist</th>
                                <th class="text-end min-w-120px">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 fw-semibold"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script src="@Url.Content("~/Scripts/library.js?v=5.0")" type="text/javascript"></script>

    <script>
    var dtDoc;
    var clienteDoc = "", proyectoDoc = "", tipoDoc = "", estadoDoc = "";

    function FiltrarDoc() {
        clienteDoc = $('#kt_doc_cliente_select').val();
        proyectoDoc = $('#kt_doc_proyecto_select').val();
        tipoDoc = $('#kt_doc_tipo_select').val();
        estadoDoc = $('#kt_doc_estado_select').val();

        $.ajax({
            url: '@Url.Action("Listar", "DocumentoOrigen")',
            type: 'GET',
            dataType: 'json',
            data: { cliente: clienteDoc, proyecto: proyectoDoc, tipo: tipoDoc, estado: estadoDoc },
            success: function (data) {
                dtDoc.clear().rows.add(data).draw();
            },
            error: function (xhr) { console.error(xhr.responseText); }
        });
    }

    function ResetDoc() {
        $('#kt_doc_cliente_select').val('').trigger('change');
        $('#kt_doc_proyecto_select').val('').trigger('change');
        $('#kt_doc_tipo_select').val('').trigger('change');
        $('#kt_doc_estado_select').val('').trigger('change');
        FiltrarDoc();
    }

    var KTDatatablesDocOrigen = function () {

        var initDatatable = function () {
            dtDoc = $('#kt_datatable_docorigen').DataTable({
                processing: true,

                oLanguage: { sInfo: "Mostrando _START_ a _END_ de _TOTAL_ registros" },
                language: { emptyTable: "Sin datos", infoEmpty: "Sin registros" },

                ajax: {
                    url: '@Url.Action("Listar", "DocumentoOrigen")',
                    type: 'GET',
                    dataType: 'json',
                    dataSrc: function (response) { return response; }
                },

                columns: [
                    { data: 'idDocumentoOrigen' },
                    { data: 'codigo', title: "Código", searchable: true },

                    {
                        data: 'tipoDoc',
                        title: "Tipo",
                        searchable: true,
                        render: function (data, type, row) {
                            if (type !== 'display') return data;
                            let t = 'DOCUMENTO', cls = 'badge badge-light';
                            if (data === 1) { t = 'ACTA'; cls = 'badge badge-success'; }
                            if (data === 2) { t = 'COTIZACIÓN'; cls = 'badge badge-warning'; }
                            if (data === 3) { t = 'DOCUMENTO'; cls = 'badge badge-primary'; }
                            if (data === 4) { t = 'CORREO'; cls = 'badge badge-info'; }
                            if (data === 5) { t = 'WHATSAPP'; cls = 'badge badge-custom-purple'; }
                            return `<span class="${cls} p-2">${t}</span>`;
                        }
                    },

                    { data: 'nombreCli', title: "Cliente", searchable: true },
                    { data: 'nombreProyec', title: "Proyecto", searchable: true },

                    {
                        data: 'fechaDocumento',
                        title: "Fecha Doc.",
                        searchable: true,
                        render: function (data, type) {
                            if (type !== 'display') return data;
                            if (!data) return '-';
                            var fecha = new Date(parseInt(data.substr(6)));
                            var dia = fecha.getDate().toString().padStart(2, '0');
                            var mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
                            var anio = fecha.getFullYear();
                            return `${dia}/${mes}/${anio}`;
                        }
                    },

                    {
                        data: 'titulo',
                        title: "Título / Asunto",
                        searchable: true,
                        render: function (data, type, row) {
                            if (type !== 'display') return data;
                            const t = data || '';
                            const d = row.descripcion || '';
                            return `
                                <div class="d-flex flex-column">
                                    <span class="fw-bold text-gray-800 text-truncate-2">${escapeHtml(t)}</span>
                                    ${d ? `<span class="small text-muted text-truncate-2">${escapeHtml(d)}</span>` : ``}
                                </div>`;
                        }
                    },

                    {
                        data: 'estado',
                        title: "Estado",
                        searchable: true,
                        render: function (data, type) {
                            if (type !== 'display') return data;
                            let txt = 'REGISTRADO', cls = 'badge badge-primary';
                            if (data === 2) { txt = 'EN REVISIÓN'; cls = 'badge badge-custom-blue'; }
                            if (data === 3) { txt = 'CERRADO'; cls = 'badge badge-dark'; }
                            return `<span class="${cls} p-2">${txt}</span>`;
                        }
                    },

                    {
                        data: 'totalRequerimientos',
                        title: "Req.",
                        searchable: true,
                        render: function (data, type) {
                            if (type !== 'display') return data;
                            return `<span class="badge badge-circle badge-secondary">${data ?? 0}</span>`;
                        }
                    },

                    {
                        data: 'tieneChecklist',
                        title: "Checklist",
                        searchable: false,
                        render: function (data, type) {
                            if (type !== 'display') return data;
                            const cls = data ? 'badge badge-success' : 'badge badge-light';
                            const txt = data ? 'LISTO' : 'PEND.';
                            return `<span class="${cls} p-2">${txt}</span>`;
                        }
                    },

                    { data: null }
                ],

                order: [[0, 'desc']],

                columnDefs: [{
                    targets: -1,
                    data: null,
                    orderable: false,
                    className: 'text-end',
                    render: function (data, type, row) {

                        return `
                        <a href="#" class="btn btn-light btn-active-light-primary btn-sm"
                           data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end" data-kt-menu-flip="top-end">
                            Acciones
                            <span class="svg-icon fs-5 m-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                        <polygon points="0 0 24 0 24 24 0 24"></polygon>
                                        <path d="M6.70710678,15.7071068 C6.31658249,16.0976311 5.68341751,16.0976311 5.29289322,15.7071068 C4.90236893,15.3165825 4.90236893,14.6834175 5.29289322,14.2928932 L11.2928932,8.29289322 C11.6714722,7.91431428 12.2810586,7.90106866 12.6757246,8.26284586 L18.6757246,13.7628459 C19.0828436,14.1360383 19.1103465,14.7686056 18.7371541,15.1757246 C18.3639617,15.5828436 17.7313944,15.6103465 17.3242754,15.2371541 L12.0300757,10.3841378 L6.70710678,15.7071068 Z" fill="currentColor" fill-rule="nonzero" transform="translate(12.000003, 11.999999) rotate(-180.000000) translate(-12.000003, -11.999999)"></path>
                                    </g>
                                </svg>
                            </span>
                        </a>

                        <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-bold fs-7 w-175px py-4" data-kt-menu="true">
                            <div class="menu-item px-3">
                                <a href="@Url.Action("Ver", "DocumentoOrigen")?id=${row.idDocumentoOrigen}" class="menu-link px-3">Ver</a>
                            </div>

                            <div class="menu-item px-3">
                                <a href="@Url.Action("Editar", "DocumentoOrigen")?id=${row.idDocumentoOrigen}" class="menu-link px-3">Editar</a>
                            </div>

                            <div class="menu-item px-3">
                                <a href="@Url.Action("Nuevo", "Requerimiento")?idDocumentoOrigen=${row.idDocumentoOrigen}" class="menu-link px-3">
                                    Crear requerimientos
                                </a>
                            </div>

                            <div class="menu-item px-3">
                                <a target="_blank" href="@Url.Action("Checklist", "DocumentoOrigen")?id=${row.idDocumentoOrigen}" class="menu-link px-3">
                                    Imprimir checklist
                                </a>
                            </div>

                            <div class="separator my-2"></div>

                            <div class="menu-item px-3">
                                <a href="#" class="menu-link px-3 text-danger" data-kt-docorigen-table-filter="delete_row">
                                    Eliminar
                                </a>
                            </div>
                        </div>
                        `;
                    }
                }]
            });

            dtDoc.on('draw', function () {
                handleDeleteRows();
                KTMenu.createInstances();
            });
        }

        var handleSearchDatatable = function () {
            const filterSearch = document.querySelector('[data-kt-datatable-docorigen-filter="search"]');
            filterSearch.addEventListener('keyup', function (e) {
                dtDoc.search(e.target.value).draw();
            });
        }

        var handleDeleteRows = () => {
            const deleteButtons = document.querySelectorAll('[data-kt-docorigen-table-filter="delete_row"]');
            deleteButtons.forEach(d => {
                d.addEventListener('click', function (e) {
                    e.preventDefault();

                    const parent = e.target.closest('tr');
                    const titulo = parent.querySelectorAll('td')[6].innerText;
                    const id = parent.querySelectorAll('td')[0].innerText;

                    Swal.fire({
                        text: "¿Seguro que deseas eliminar el documento de origen: " + titulo + "?",
                        icon: "warning",
                        showCancelButton: true,
                        buttonsStyling: false,
                        confirmButtonText: "Si, eliminar!",
                        cancelButtonText: "No, cancelar",
                        customClass: {
                            confirmButton: "btn fw-bold btn-danger",
                            cancelButton: "btn fw-bold btn-active-light-primary"
                        }
                    }).then(function (result) {
                        if (result.value) {
                            $.ajax({
                                type: "POST",
                                url: "@Url.Action("Eliminar", "DocumentoOrigen")",
                                data: { id: id },
                                success: function () {
                                    Swal.fire({
                                        text: "Documento eliminado.",
                                        icon: "success",
                                        buttonsStyling: false,
                                        confirmButtonText: "Ok",
                                        customClass: { confirmButton: "btn fw-bold btn-primary" }
                                    }).then(function () {
                                        dtDoc.ajax.reload();
                                    });
                                },
                                error: function (xhr) {
                                    Swal.fire({
                                        text: "Error eliminando: " + (xhr.responseText || ""),
                                        icon: "error",
                                        buttonsStyling: false,
                                        confirmButtonText: "Ok",
                                        customClass: { confirmButton: "btn fw-bold btn-primary" }
                                    });
                                }
                            });
                        }
                    });
                })
            });
        }

        function escapeHtml(s) {
            if (s === null || s === undefined) return '';
            return String(s).replace(/[&<>"']/g, function (m) {
                return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m];
            });
        }

        return {
            init: function () {
                initDatatable();
                handleSearchDatatable();
                handleDeleteRows();
            }
        }
    }();

    $(document).ready(function () {
        KTUtil.onDOMContentLoaded(function () {
            KTDatatablesDocOrigen.init();
        });
    });
    </script>
}
