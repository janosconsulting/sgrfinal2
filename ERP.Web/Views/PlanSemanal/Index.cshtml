
@{
    ViewBag.Title = "Plan Semanal";
    Layout = "~/Views/Shared/_Layout2.cshtml";

    var lunes = Model.Plan.lunesTexto;         // "yyyy-MM-dd"
    var idPlanSemana = Model.Plan.idPlanSemana;
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
     /* =========================================================
    PLAN SEMANAL (Metronic Light) - CSS scoped
    Usa dentro del wrapper: <div class="plan-semanal"> ... </div>
    ========================================================= */

     .plan-semanal {
         --ps-line: rgba(15, 23, 42, .12);
         --ps-soft: rgba(15, 23, 42, .04);
         --ps-text: #0f172a;
         --ps-muted: #64748b;
         --ps-shadow: 0 10px 24px rgba(15,23,42,.08);
         --ps-radius: 16px;
     }

         /* Helpers */
         .plan-semanal .ps-muted {
             color: var(--ps-muted) !important;
         }

         .plan-semanal .ps-small {
             font-size: .85rem;
         }

         /* LEFT: Tree */
         .plan-semanal #tree {
             display: flex;
             flex-direction: column;
             gap: 12px;
         }

         .plan-semanal .req {
             border: 1px solid var(--ps-line);
             border-radius: var(--ps-radius);
             background: #fff;
             overflow: hidden;
             transition: .15s ease;
         }

             .plan-semanal .req:hover {
                 box-shadow: var(--ps-shadow);
                 transform: translateY(-1px);
             }

         .plan-semanal .req-head {
             padding: 12px 12px 10px 12px;
             display: flex;
             align-items: flex-start;
             justify-content: space-between;
             gap: 12px;
             cursor: pointer;
             background: linear-gradient(180deg, rgba(15,23,42,.02), transparent);
         }

         .plan-semanal .req-title {
             margin: 0;
             font-weight: 800;
             font-size: .95rem;
             color: var(--ps-text);
             line-height: 1.25;
         }

         .plan-semanal .req-meta {
             margin-top: 6px;
             display: flex;
             flex-wrap: wrap;
             gap: 8px;
         }

         .plan-semanal .pill {
             display: inline-flex;
             align-items: center;
             gap: 6px;
             padding: .25rem .55rem;
             border-radius: 999px;
             border: 1px solid var(--ps-line);
             background: var(--ps-soft);
             color: rgba(15,23,42,.85);
             font-size: .75rem;
             white-space: nowrap;
         }

         /* Sublist */
         .plan-semanal .sublist {
             padding: 0 12px 12px 12px;
             display: none;
         }

         .plan-semanal .req.open .sublist {
             display: block;
         }

         .plan-semanal .subitem {
             margin-top: 10px;
             border: 1px solid rgba(15,23,42,.10);
             border-radius: 14px;
             background: #fff;
             padding: 10px 10px 10px 12px;
             cursor: pointer;
             transition: .15s ease;
         }

             .plan-semanal .subitem:hover {
                 border-color: rgba(0, 158, 247, .35); /* primary Metronic */
                 box-shadow: 0 10px 20px rgba(15,23,42,.06);
                 transform: translateY(-1px);
             }

             .plan-semanal .subitem.selected {
                 outline: 3px solid rgba(0, 158, 247, .22);
                 outline-offset: 2px;
             }

         .plan-semanal .subrow {
             display: flex;
             align-items: flex-start;
             justify-content: space-between;
             gap: 10px;
         }

         .plan-semanal .subname {
             margin: 0;
             font-weight: 800;
             font-size: .9rem;
             color: var(--ps-text);
         }

         .plan-semanal .submeta {
             margin-top: 6px;
             display: flex;
             flex-wrap: wrap;
             gap: 8px;
             color: var(--ps-muted);
             font-size: .8rem;
         }

         /* CENTER: Board */
         .plan-semanal #board {
             scrollbar-width: thin;
         }

         .plan-semanal .ps-col {
             min-width: 260px;
             max-width: 260px;
             border: 1px solid var(--ps-line);
             border-radius: var(--ps-radius);
             background: #fff;
             overflow: hidden;
             display: flex;
             flex-direction: column;
         }

         .plan-semanal .ps-col-head {
             padding: 12px;
             border-bottom: 1px solid rgba(15,23,42,.08);
             background: linear-gradient(180deg, rgba(15,23,42,.02), transparent);
             display: flex;
             align-items: center;
             justify-content: space-between;
             gap: 10px;
         }

         .plan-semanal .ps-col-title {
             margin: 0;
             font-weight: 900;
             font-size: .92rem;
             color: var(--ps-text);
         }

     .dropzone {
         min-height: 400px !important;
     }

     .plan-semanal .ps-col-date {
         font-size: .8rem;
         color: var(--ps-muted);
         white-space: nowrap;
     }

     .plan-semanal .ps-dropzone {
         padding: 12px;
         display: flex;
         flex-direction: column;
         gap: 12px;
         min-height: 520px;
     }

     .plan-semanal .ps-col.dragover {
         outline: 2px dashed rgba(0, 158, 247, .35);
         outline-offset: -8px;
     }

     /* Cards (Tarjetas) */
     .plan-semanal .cardtask {
         border: 1px solid rgba(15,23,42,.12);
         border-radius: 14px;
         background: #fff;
         padding: 12px 12px 12px 14px;
         box-shadow: 0 10px 18px rgba(15,23,42,.06);
         cursor: grab;
         position: relative;
         transition: .15s ease;
     }

         .plan-semanal .cardtask:hover {
             transform: translateY(-1px);
             box-shadow: 0 12px 26px rgba(15,23,42,.10);
         }

         .plan-semanal .cardtask:active {
             cursor: grabbing;
         }

         .plan-semanal .cardtask.ghost {
             opacity: .55;
         }

         /* bar color por estado */
         .plan-semanal .cardtask .bar {
             position: absolute;
             left: 0;
             top: 12px;
             bottom: 12px;
             width: 5px;
             border-radius: 999px;
             background: #009EF7; /* default primary */
         }

     .plan-semanal .status-pendiente .bar {
         background: #009EF7;
     }

     .plan-semanal .status-proceso .bar {
         background: #FFC700;
     }

     .plan-semanal .status-hecho .bar {
         background: #50CD89;
     }

     .plan-semanal .status-bloqueado .bar {
         background: #F1416C;
     }

     .plan-semanal .ctitle {
         margin: 0 0 8px 10px;
         font-weight: 900;
         font-size: .92rem;
         color: var(--ps-text);
         line-height: 1.25;
     }

     .plan-semanal .cmeta {
         margin-left: 10px;
         display: flex;
         flex-wrap: wrap;
         gap: 8px;
         color: var(--ps-muted);
         font-size: .8rem;
     }

     .plan-semanal .pri {
         width: 8px;
         height: 8px;
         border-radius: 999px;
         display: inline-block;
     }

         .plan-semanal .pri.p1 {
             background: #F1416C;
         }

         .plan-semanal .pri.p2 {
             background: #FFC700;
         }

         .plan-semanal .pri.p3 {
             background: #50CD89;
         }

     /* Panel derecho */
     .plan-semanal #detailPane .p-4.border-dashed.rounded {
         border-color: rgba(15,23,42,.18) !important;
         background: rgba(15,23,42,.02);
     }

     /* Toast (si usas tu toast) */
     .plan-semanal .toast {
         position: fixed;
         left: 16px;
         bottom: 16px;
         padding: 10px 12px;
         border-radius: 12px;
         border: 1px solid rgba(15,23,42,.14);
         background: #fff;
         box-shadow: var(--ps-shadow);
         color: var(--ps-text);
         display: none;
         z-index: 1050;
     }

     /* Modal (si mantienes tu modal custom) */
     .plan-semanal .modal-backdrop {
         background: rgba(15,23,42,.35);
     }

     .plan-semanal .modal {
         background: #fff;
         border: 1px solid rgba(15,23,42,.14);
         border-radius: 18px;
         overflow: hidden;
     }

         .plan-semanal .modal header,
         .plan-semanal .modal footer {
             border-color: rgba(15,23,42,.10);
         }


    /* ===== CARD MEJORADA ===== */

    .plan-semanal .cardtask {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px 12px 10px 16px;
    }

    /* Header info */
    .plan-semanal .card-header-info {
        margin-left: 10px;
        line-height: 1.25;
    }

    /* Body */
    .plan-semanal .card-body-info {
        margin-left: 10px;
    }

    .plan-semanal .ctitle {
        font-weight: 800;
        font-size: .95rem;
        margin-bottom: 6px;
        line-height: 1.3;
    }

    /* Metadata */
    .plan-semanal .cmeta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    /* Footer actions */
    .plan-semanal .card-footer-actions {
        display: flex;
        gap: 6px;
        margin-left: 10px;
        margin-top: 4px;
        opacity: 0;
        transition: .15s ease;
    }

    .plan-semanal .cardtask:hover .card-footer-actions {
        opacity: 1;
    }

    /* Reduce badges */
    .plan-semanal .badge {
        font-size: .7rem;
        padding: .35em .55em;
    }
    .plan-semanal .cardtask:hover {
        transform: scale(1.02);
    }
    .plan-semanal .ctitle {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* ===== CARD COMPACTA ===== */
    .plan-semanal .card-compact {
        padding: 8px 8px 6px 12px;
        gap: 4px;
    }

        /* Header */
        .plan-semanal .card-compact .card-header-info {
            margin-left: 8px;
            line-height: 1.1;
        }

        /* Body */
        .plan-semanal .card-compact .card-body-info {
            margin-left: 8px;
        }

        .plan-semanal .card-compact .ctitle {
            font-weight: 700;
            font-size: .85rem;
            margin-bottom: 4px;
        }

        /* Metadata pills */
        .plan-semanal .card-compact .cmeta {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

    .plan-semanal .meta-pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 1px 6px;
        font-size: .68rem;
        border-radius: 999px;
        background: #f1f5f9;
        color: #334155;
        white-space: nowrap;
    }

    /* Prioridad */
    .plan-semanal .pri-1 {
        background: #fee2e2;
        color: #991b1b;
    }

    .plan-semanal .pri-2 {
        background: #fef9c3;
        color: #854d0e;
    }

    .plan-semanal .pri-3 {
        background: #dcfce7;
        color: #166534;
    }

    /* Actions */
    .plan-semanal .card-actions {
        display: flex;
        gap: 4px;
        margin-left: 8px;
        opacity: 0;
        transition: .15s ease;
    }

    .plan-semanal .card-compact:hover .card-actions {
        opacity: 1;
    }

    /* Mini buttons */
    .plan-semanal .btn-xxs {
        padding: .15rem .25rem;
        min-height: auto;
    }

</style>

<!--begin::Content-->
<div id="kt_app_content" class="app-content flex-column-fluid plan-semanal">
    <!--begin::Content container-->
    <div id="kt_app_content_container" class="app-container container-fluid">

        <div class="row g-5">

            <!-- LEFT: Requerimientos -->
            <div class="col-12 col-xl-2">
                <div class="card card-flush h-100">
                    <div class="card-header pt-5">
                        <div class="card-title d-flex align-items-center gap-2">
                            <i class="bi bi-diagram-3 fs-3 text-primary"></i>
                            <h3 class="fw-bold m-0">Requerimientos</h3>
                        </div>

                        <div class="card-toolbar">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-light-primary" id="btnExport">
                                    <i class="bi bi-filetype-json"></i> Export
                                </button>

                                <button type="button" class="btn btn-sm btn-light" id="btnClearSel" title="Limpiar selección">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card-body pt-2">
                        <div class="d-flex gap-2 mb-4">
                            <input id="qReq" class="form-control form-control-sm" placeholder="Buscar requerimiento / subrequerimiento..." />
                            <button type="button" class="btn btn-sm btn-primary" id="btnSearch">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>

                        <div class="text-muted fs-7">
                            Selecciona un <span class="fw-bold">SubRequerimiento</span> para ver su trazabilidad (derecha) y crear tarjetas del plan asociadas.
                        </div>

                        <div class="separator my-4"></div>

                        <!-- Tree -->
                        <div id="tree"></div>
                    </div>
                </div>
            </div>

            <!-- CENTER: Plan Semanal -->
            <div class="col-12 col-xl-8">
                <div class="card card-flush h-100">
                    <div class="card-header pt-5">
                        <select id="fTrabajador" class="form-select form-select-sm" style="min-width:220px;" data-control="select2" data-placeholder="Todos">
                            <option></option>
                        </select>
                        <div class="card-title d-flex flex-column">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-calendar2-week fs-3 text-primary"></i>
                                <h3 class="fw-bold m-0">Plan Semanal</h3>
                            </div>
                            <div class="text-muted fs-7 mt-1" id="weekLabel"></div>
                        </div>

                        <div class="card-toolbar">
                            <div class="d-flex gap-2 flex-wrap">
                                <button type="button" class="btn btn-sm btn-light" id="btnPrev" title="Semana anterior">
                                    <i class="bi bi-chevron-left"></i>
                                </button>

                                <button type="button" class="btn btn-sm btn-light-primary" id="btnToday">
                                    <i class="bi bi-dot"></i> Hoy
                                </button>

                                <button type="button" class="btn btn-sm btn-light" id="btnNext" title="Semana siguiente">
                                    <i class="bi bi-chevron-right"></i>
                                </button>

                                <button type="button" class="btn btn-sm btn-primary" id="btnNewCard">
                                    <i class="bi bi-plus-lg"></i> Tarjeta
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card-body pt-2">
                        <div class="text-muted fs-7 mb-4">
                            Arrastra tarjetas entre días. Cada tarjeta apunta a un <span class="fw-bold">SubRequerimiento</span> (y opcional a una <span class="fw-bold">Observación</span>).
                        </div>

                        <!-- Board (scroll horizontal si son 7 columnas) -->
                        <div class="d-flex flex-nowrap gap-4 overflow-auto pb-3" id="board" style="min-height:520px;">
                            @* Aquí tu JS inyecta columnas/días *@
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Trazabilidad -->
            <div class="col-12 col-xl-2">
                <div class="card card-flush h-100">
                    <div class="card-header pt-5">
                        <div class="card-title d-flex align-items-center gap-2">
                            <i class="bi bi-bezier2 fs-3 text-primary"></i>
                            <h3 class="fw-bold m-0">Trazabilidad</h3>
                        </div>

                        <div class="card-toolbar">
                            <button type="button" class="btn btn-sm btn-primary" id="btnNewObs">
                                <i class="bi bi-chat-left-text"></i> Observación
                            </button>
                        </div>
                    </div>

                    <div class="card-body pt-2" id="detailPane">
                        <div class="p-4 border border-dashed rounded">
                            <div class="fw-bold">Selecciona un SubRequerimiento</div>
                            <div class="text-muted fs-7 mt-2">
                                Aquí verás el detalle y el timeline de observaciones del cliente.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>
    <!--end::Content container-->
</div>
<!--end::Content-->
<!-- MODAL -->

<!--begin::Modal - Tarjeta-->
<div class="modal fade" id="kt_modal_tarjeta"  tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h2 class="fw-bold" id="kt_modal_tarjeta_title">
                    <i class="bi bi-kanban me-2 text-primary"></i> Tarjeta
                </h2>
                <div class="btn btn-icon btn-sm btn-light" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i>
                </div>
            </div>

            <div class="modal-body py-5" id="kt_modal_tarjeta_body">
                <!-- Aquí se inyecta el partial -->
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="kt_modal_tarjeta_save">
                    <i class="bi bi-check-lg"></i> Guardar
                </button>
            </div>

        </div>
    </div>
</div>
<!--end::Modal-->

<div class="toast" id="toast"></div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    // ====== Datos "como antes" (ViewBag) ======
    const ID_PLAN = @idPlanSemana;
    const LUNES_ISO = "@lunes"; // yyyy-MM-dd
    const DAY_NAMES = ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];
    var toastr;
    // Selección actual
    let selected = { reqId: null, subId: null, subNombre: null, reqCodigo: null, reqNombre: null };

    // Cache tree/carts
    let treeData = { reqs: [], subs: [] };
    let cardsData = [];
    let modalTarjeta;
    $(function () {
        modalTarjeta = new bootstrap.Modal(
            document.getElementById('kt_modal_tarjeta'),
            { backdrop: 'static' }
        );
        initFiltroTrabajador();
        $("#kt_modal_tarjeta_save").on("click", function () {
            const $form = $("#kt_modal_tarjeta_body").find("form");
            if ($form.length === 0) {
                modalTarjeta.hide();
                return;
            }

            $.ajax({
                url: $form.attr("action"),
                type: "POST",
                data: $form.serialize(),
                success: function (res) {
                    if (res && res.idResultado === 1) {
                        toastr.success(res.mensaje || "Guardado correctamente");
                        modalTarjeta.hide();
                        loadCards();
                    } else {
                        toastr.error(res?.mensaje || "No se pudo guardar");
                    }
                },
                error: function () {
                    toastr.error("Error al guardar la tarjeta");
                }
            });
        });
        renderWeekLabel();
        buildBoardCols();
        loadTree("");
       
        loadCards();
       
        $("#btnSearch").on("click", function(){ loadTree($("#qReq").val() || ""); });
        $("#qReq").on("keydown", function(e){ if(e.key === "Enter") loadTree($("#qReq").val() || ""); });

        $("#btnClearSel").on("click", function(){
            selected = { reqId:null, subId:null, subNombre:null, reqCodigo:null, reqNombre:null };
            renderTree();
            renderDetailEmpty();
        });

        $("#btnNewCard").on("click", function () {
            console.log(1)
            if (!selected.reqId) {
                //toast("Selecciona un SubRequerimiento primero.");
                toastr.error("Selecciona un Requerimiento primero.");
                return;
            }
            if(!selected.subId){
                //toast("Selecciona un SubRequerimiento primero.");
                toastr.error("Selecciona un SubRequerimiento primero.");
                return;
            }
            openTarjetaModal(0, selected.subId, null, 0);
        });

        // Navegación semana (recarga para que tu Index calcule lunes e IdPlanSemana real)
        $("#btnPrev").on("click", function(){
            const d = addDays(parseISO(LUNES_ISO), -7);
            window.location = "@Url.Action("Index","PlanSemanal")?fecha=" + formatISO(d);
        });
        $("#btnNext").on("click", function(){
            const d = addDays(parseISO(LUNES_ISO), 7);
            window.location = "@Url.Action("Index","PlanSemanal")?fecha=" + formatISO(d);
        });
        $("#btnToday").on("click", function(){
            window.location = "@Url.Action("Index","PlanSemanal")";
        });

        // Modal hooks
        $("#btnClose, #btnCancel").on("click", closeModal);
        $("#modalBackdrop").on("click", function(e){ if(e.target.id === "modalBackdrop") closeModal(); });

        // Guardar modal: submit del form parcial
        $("#btnSave").on("click", function(){
            const $form = $("#modalBody").find("form");
            if($form.length===0){ closeModal(); return; }

            $.ajax({
                url: $form.attr("action"),
                type: "POST",
                data: $form.serialize(),
                success: function(res){
                    if(res && res.idResultado === 1){ // exito
                        toast(res.mensaje || "Guardado");
                        closeModal();
                        loadCards();
                    } else {
                        toast((res && res.mensaje) ? res.mensaje : "No se pudo guardar");
                    }
                },
                error: function(xhr){
                    toast("Error al guardar: " + (xhr.responseText || ""));
                }
            });
        });
    });
    function initTrabajadorCombo() {
        const $t = $("#ddlTrabajador");
        const sel = parseInt($("#hdTrabSelected").val() || "0", 10);

        $.get("@Url.Action("ListarTrabajadores2", "Trabajador")")
          .done(function(r){
            if(!r || !r.ok){ toastr.error(r?.error || "Error trabajadores"); return; }

            $t.empty().append('<option></option>');
            (r.lista || []).forEach(x=>{
                $t.append(`<option value="${x.idPersona}">${esc(x.nombreCli)}</option>`);
            });

            if(sel > 0) $t.val(sel);

            if ($t.data("select2")) $t.select2("destroy");
            $t.select2({ dropdownParent: $("#kt_modal_tarjeta") });

          }).fail(function(){ toastr.error("No se pudo cargar trabajadores"); });
    }


    function renderWeekLabel(){
        const end = addDays(parseISO(LUNES_ISO), 6);
        $("#weekLabel").text(`${formatLong(parseISO(LUNES_ISO))} — ${formatLong(end)} (${LUNES_ISO})`);
    }

    function buildBoardCols(){
        const $board = $("#board");
        $board.html("");
        for(let d=0; d<7; d++){
            const date = addDays(parseISO(LUNES_ISO), d);
            const $col = $(`
              <div class="col" data-day="${d}">
                <h3>${DAY_NAMES[d]} <span>${formatShort(date)}</span></h3>
                <div class="dropzone" data-day="${d}"></div>
              </div>
            `);

            // drag drop
            $col.on("dragover", function(e){ e.preventDefault(); $col.addClass("dragover"); });
            $col.on("dragleave", function(){ $col.removeClass("dragover"); });
            $col.on("drop", function(e){
                e.preventDefault(); $col.removeClass("dragover");
                const id = e.originalEvent.dataTransfer.getData("text/cardId");
                if(!id) return;
                moverTarjeta(parseInt(id,10), d);
            });

            $board.append($col);
        }
    }

    // ========= AJAX =========
    function loadTree(q){
        $.get("@Url.Action("Tree","PlanSemanal")", { q: q || "" })
            .done(function(r){
                if(!r || !r.ok){ toast(r?.error || "Error Tree"); return; }
                treeData.reqs = r.reqs || [];
                treeData.subs = r.subs || [];
                renderTree();
            })
            .fail(function(){ toast("Error cargando tree"); });
    }
    let filtroTrabajador = null;

    function initFiltroTrabajador(){
      const $f = $("#fTrabajador");

      $.get("@Url.Action("ListarTrabajadores2", "Trabajador")")
        .done(function(r){
          if(!r || !r.ok){ toastr.error(r?.error || "Error trabajadores"); return; }

          $f.empty().append('<option></option>');
          (r.lista||[]).forEach(x=>{
              $f.append(`<option value="${x.idPersona}">${esc(x.nombreCli)}</option>`);
          });

          $f.select2(); // fuera de modal
          $f.on("change", function(){
            const v = $(this).val();
            filtroTrabajador = v ? parseInt(v,10) : null;
            loadCards(); // recarga con filtro
          });
        });
    }

    function loadCards(){
        $.get("@Url.Action("ListarTarjetas","PlanSemanal")", {
            idPlanSemana: ID_PLAN,
            idPersonaResponsable: filtroTrabajador })
            .done(function(r){
                if(!r || !r.ok){ toast(r?.error || "Error Cards"); return; }
                cardsData = r.cards || [];
                renderCards();
            })
            .fail(function(){ toast("Error cargando tarjetas"); });
    }

    // ========= Render Tree =========
    function renderTree(){
        const $tree = $("#tree");
        $tree.html("");

        // Agrupar subs por requerimiento
        const subsByReq = {};
        (treeData.subs || []).forEach(s=>{
            subsByReq[s.idRequerimiento] = subsByReq[s.idRequerimiento] || [];
            subsByReq[s.idRequerimiento].push(s);
        });

        (treeData.reqs || []).forEach(r=>{
            const subs = subsByReq[r.idRequerimiento] || [];
            const open = (selected.reqId === r.idRequerimiento);

            const $req = $(`
                <div class="req ${open ? "open":""}" data-req="${r.idRequerimiento}">
                  <div class="req-head">
                    <div>
                      <p class="req-title">${esc(r.codigo)} — ${esc(r.nombre)}</p>
                      <div class="req-meta">
                        <span class="pill"><i class="bi bi-diagram-3"></i> ${subs.length} SubReq</span>
                      </div>
                    </div>
                    <div class="req-tools"></div>
                  </div>
                  <div class="sublist"></div>
                </div>
            `);

            $req.find(".req-head").on("click", function(ev){
                if($(ev.target).closest(".iconbtn").length) return;
                if(selected.reqId === r.idRequerimiento && !selected.subId){
                    selected.reqId = null;
                }else{
                    selected.reqId = r.idRequerimiento;
                    if(selected.subId){
                        const has = subs.some(x=>x.idRequerimientoDetalle === selected.subId);
                        if(!has) selected.subId = null;
                    }
                }
                renderTree();
                if(!selected.subId) renderDetailEmpty();
            });

            const $sublist = $req.find(".sublist");
            subs.forEach(s=>{
                const isSel = (selected.subId === s.idRequerimientoDetalle);
                const $sub = $(`
                    <div class="subitem ${isSel ? "selected":""}" data-sub="${s.idRequerimientoDetalle}">
                      <div class="subrow">
                        <div>
                          <p class="subname">${esc(s.nombre)}</p>
                          <div class="submeta">
                            <span class="pill"><i class="bi bi-flag"></i> ${esc(s.estado || "Pendiente")}</span>
                            <span class="pill"><i class="bi bi-exclamation-circle"></i> P${(s.prioridad||2)}</span>
                          </div>
                        </div>
                        <div class="subtools"></div>
                      </div>
                    </div>
                `);

                $sub.on("click", function(){
                    selected.reqId = r.idRequerimiento;
                    selected.subId = s.idRequerimientoDetalle;
                    selected.subNombre = s.nombre;
                    selected.reqCodigo = r.codigo;
                    selected.reqNombre = r.nombre;
                    renderTree();
                    renderDetailSelected();
                });

                $sublist.append($sub);
            });

            $tree.append($req);
        });
    }

    // ========= Render Cards =========
    function renderCards(){
        // limpiar dropzones
        $("#board .dropzone").html("");

        (cardsData || []).forEach(c=>{
            const d = c.dia ?? 0;
            const $zone = $(`#board .dropzone[data-day="${d}"]`);
            if($zone.length===0) return;

            const priClass = (c.prioridad==1 ? "p1" : (c.prioridad==2 ? "p2" : "p3"));
            const status = (c.estado || "pendiente").toLowerCase();

            const $card = $(`
                <div class="cardtask card-compact status-${esc(status)}" draggable="true" data-id="${c.idPlanDetalle}">

                    <!-- Barra de estado -->
                    <div class="bar"></div>

                    <!-- Header -->
                    <div class="card-header-info">
                        <div class="fw-bold text-primary fs-9 lh-1">
                            ${esc(c.reqCodigo)} · ${esc(c.subNombre)}
                        </div>
                        <div class="text-muted fs-9 lh-1">
                            ${esc(c.reqNombre)}
                        </div>
                    </div>

                    <!-- Body -->
                    <div class="card-body-info">
                        <div class="ctitle lh-sm">
                            ${esc(c.titulo)}
                        </div>

                        <div class="cmeta">
                            <span class="meta-pill">
                                <i class="bi bi-person"></i> ${esc(c.responsable || "—")}
                            </span>

                            <span class="meta-pill">
                                <i class="bi bi-calendar-event"></i> ${esc((c.fechaDia || "").substring(0, 10))}
                            </span>

                            <span class="meta-pill pri-${c.prioridad}">
                                P${c.prioridad}
                            </span>

                            ${c.idObservacion ? `
                            <span class="meta-pill">
                                <i class="bi bi-chat-left-text"></i>
                            </span>` : ``}
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="card-actions">
                        <button class="btn btn-icon btn-xxs btn-light-primary" data-act="edit">
                            <i class="bi bi-pencil fs-8"></i>
                        </button>
                        <button class="btn btn-icon btn-xxs btn-light-danger" data-act="del">
                            <i class="bi bi-trash fs-8"></i>
                        </button>
                    </div>

                </div>
                `);


            $card.on("dragstart", function(e){
                $card.addClass("ghost");
                e.originalEvent.dataTransfer.setData("text/cardId", c.idPlanDetalle);
            });
            $card.on("dragend", function(){ $card.removeClass("ghost"); });

            $card.find('[data-act="edit"]').on("click", function(ev){
                ev.preventDefault();
                openTarjetaModal(c.idPlanDetalle, c.idRequerimientoDetalle, c.idObservacion, c.dia);
            });
            $card.find('[data-act="del"]').on("click", function(ev){
                ev.preventDefault();
                eliminarTarjeta(c.idPlanDetalle);
            });

            $zone.append($card);
        });
    }

    // ========= Right panel =========
    function renderDetailEmpty(){
        $("#detailPane").html(`
          <div class="detailbox">
            <p class="detail-title">Selecciona un SubRequerimiento</p>
            <p class="small muted" style="margin:8px 0 0">Aquí verás el detalle y la trazabilidad.</p>
          </div>
        `);
    }

    function renderDetailSelected(){
        if(!selected.subId){
            renderDetailEmpty();
            return;
        }

        $("#detailPane").html(`
          <div class="detailbox">
            <p class="detail-title">${esc(selected.reqCodigo || "")} — ${esc(selected.reqNombre || "")}</p>
            <div class="detail-meta">
              <span class="pill"><i class="bi bi-diagram-3"></i> SubReq: <b>${esc(selected.subNombre || ("#"+selected.subId))}</b></span>
            </div>
            <div style="margin-top:10px" class="small muted">
              (Aquí conectas Observaciones reales cuando metas tu ObservacionController.)
            </div>
          </div>
        `);
    }

    function openTarjetaModal(idPlanDetalle, idRequerimientoDetalle, idObservacion, dia) {
        $.get("@Url.Action("FormTarjeta","PlanSemanal")", {
            idPlanSemana: ID_PLAN,
            idPlanDetalle: idPlanDetalle,
            idRequerimientoDetalle: idRequerimientoDetalle,
            idObservacion: idObservacion,
            dia: dia
        }).done(function (html) {

            $("#kt_modal_tarjeta_title").html(
                `<i class="bi bi-kanban me-2 text-primary"></i>
                 ${idPlanDetalle > 0 ? "Editar" : "Nueva"} Tarjeta`
            );

            $("#kt_modal_tarjeta_body").html(html);
            initTarjetaCombos();
            initTrabajadorCombo();
            modalTarjeta.show();

        }).fail(function () {
            toastr.error("No se pudo cargar el formulario");
        });
    }

    function initTarjetaCombos() {

        const $req = $("#ddlRequerimiento");
        const $sub = $("#ddlSubRequerimiento");

        // Preselección (viene del hidden)
        const subSelected = parseInt($("#hdSubSelected").val() || "0", 10);

        // Cargar tree real
        $.get("@Url.Action("Tree","PlanSemanal")", { q: "" })
            .done(function (r) {
                if (!r || !r.ok) { toastr.error(r?.error || "Error Tree"); return; }

                const reqs = r.reqs || [];
                const subs = r.subs || [];

                // Detectar requerimiento padre del sub seleccionado
                let reqSelected = 0;
                if (subSelected > 0) {
                    const subItem = subs.find(x => parseInt(x.idRequerimientoDetalle) === subSelected);
                    if (subItem) reqSelected = parseInt(subItem.idRequerimiento);
                }

                // Llenar Requerimientos
                $req.empty().append('<option></option>');
                reqs.forEach(rr => {
                    $req.append(`<option value="${rr.idRequerimiento}">${esc(rr.codigo)} — ${esc(rr.nombre)}</option>`);
                });

                // Set req seleccionado
                if (reqSelected > 0) $req.val(reqSelected);

                // Cargar subrequerimientos según req seleccionado
                fillSubsByReq(subs, $sub, reqSelected, subSelected);

                // change req => refresca subs
                $req.off("change.ps").on("change.ps", function () {
                    const idReq = parseInt($(this).val() || "0", 10);
                    fillSubsByReq(subs, $sub, idReq, 0);
                });

                // Re-init select2 (Metronic)
                if ($req.data("select2")) $req.select2("destroy");
                if ($sub.data("select2")) $sub.select2("destroy");

                $req.select2({ dropdownParent: $("#kt_modal_tarjeta") });
                $sub.select2({ dropdownParent: $("#kt_modal_tarjeta") });

            })
            .fail(function () {
                toastr.error("No se pudo cargar requerimientos");
            });
    }

    function fillSubsByReq(subs, $sub, idReq, subSelected) {
        $sub.empty().append('<option></option>');

        const lista = (subs || []).filter(s => parseInt(s.idRequerimiento) === parseInt(idReq));
        lista.forEach(s => {
            const label = `${esc(s.nombre)}${s.estado ? " (" + esc(s.estado) + ")" : ""}`;
            $sub.append(`<option value="${s.idRequerimientoDetalle}">${label}</option>`);
        });

        if (subSelected && subSelected > 0) $sub.val(subSelected);
    }


    function closeModal(){
        $("#modalBackdrop").hide();
        $("#modalBody").html("");
    }

    // ========= Actions =========
    function moverTarjeta(idPlanDetalle, dia){
        $.post("@Url.Action("MoverTarjeta","PlanSemanal")", { idPlanDetalle: idPlanDetalle, dia: dia })
            .done(function(res){
                if(res && res.idResultado === 1){
                    toast("Tarjeta movida");
                    loadCards();
                }else{
                    toast(res?.mensaje || "No se pudo mover");
                }
            })
            .fail(function(){ toast("Error al mover tarjeta"); });
    }

    function eliminarTarjeta(idPlanDetalle){
        if(!confirm("¿Eliminar tarjeta?")) return;

        $.post("@Url.Action("EliminarTarjeta","PlanSemanal")", { idPlanDetalle: idPlanDetalle })
            .done(function(res){
                if(res && res.idResultado === 1){
                    toast("Eliminado");
                    loadCards();
                }else{
                    toast(res?.mensaje || "No se pudo eliminar");
                }
            })
            .fail(function(){ toast("Error al eliminar"); });
    }

    // ========= Utils =========
    function toast(msg){
        const t = $("#toast");
        t.text(msg).show();
        clearTimeout(window.__toastTimer);
        window.__toastTimer = setTimeout(()=>t.hide(), 2600);
    }
    function esc(v){
        return String(v ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }
    function parseISO(s){
        const parts = (s || "").split("-");
        return new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]));
    }
    function addDays(d, n){
        const x = new Date(d.getTime());
        x.setDate(x.getDate()+n);
        return x;
    }
    function formatISO(d){
        const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${da}`;
    }
    function formatShort(d){
        const da=String(d.getDate()).padStart(2,"0"), mo=String(d.getMonth()+1).padStart(2,"0");
        return `${da}/${mo}`;
    }
    function formatLong(d){
        const months=["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
        return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }
</script>
