
@{
    ViewBag.Title = "Plan Semanal";
    Layout = "~/Views/Shared/_Layout2.cshtml";

    var lunes = Model.Plan.lunesTexto;         // "yyyy-MM-dd"
    var idPlanSemana = Model.Plan.idPlanSemana;
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
<style>
    /* =========================================================
    PLAN SEMANAL (Metronic Light) - CSS scoped
    Usa dentro del wrapper: <div class="plan-semanal"> ... </div>
    ========================================================= */

    .plan-semanal {
        --ps-line: rgba(15, 23, 42, .12);
        --ps-soft: rgba(15, 23, 42, .04);
        --ps-text: #0f172a;
        --ps-muted: #64748b;
        --ps-shadow: 0 10px 24px rgba(15,23,42,.08);
        --ps-radius: 16px;
    }

        /* Helpers */
        .plan-semanal .ps-muted {
            color: var(--ps-muted) !important;
        }

        .plan-semanal .ps-small {
            font-size: .85rem;
        }

        /* LEFT: Tree */
        .plan-semanal #tree {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .plan-semanal .req {
            border: 1px solid var(--ps-line);
            border-radius: var(--ps-radius);
            background: #fff;
            overflow: hidden;
            transition: .15s ease;
        }

            .plan-semanal .req:hover {
                box-shadow: var(--ps-shadow);
                transform: translateY(-1px);
            }

        .plan-semanal .req-head {
            padding: 12px 12px 10px 12px;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            cursor: pointer;
            background: linear-gradient(180deg, rgba(15,23,42,.02), transparent);
        }

        .plan-semanal .req-title {
            margin: 0;
            font-weight: 800;
            font-size: .95rem;
            color: var(--ps-text);
            line-height: 1.25;
        }

        .plan-semanal .req-meta {
            margin-top: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .plan-semanal .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: .25rem .55rem;
            border-radius: 999px;
            border: 1px solid var(--ps-line);
            background: var(--ps-soft);
            color: rgba(15,23,42,.85);
            font-size: .75rem;
            white-space: nowrap;
        }

        /* Sublist */
        .plan-semanal .sublist {
            padding: 0 12px 12px 12px;
            display: none;
        }

        .plan-semanal .req.open .sublist {
            display: block;
        }

        .plan-semanal .subitem {
            margin-top: 10px;
            border: 1px solid rgba(15,23,42,.10);
            border-radius: 14px;
            background: #fff;
            padding: 10px 10px 10px 12px;
            cursor: pointer;
            transition: .15s ease;
        }

            .plan-semanal .subitem:hover {
                border-color: rgba(0, 158, 247, .35); /* primary Metronic */
                box-shadow: 0 10px 20px rgba(15,23,42,.06);
                transform: translateY(-1px);
            }

            .plan-semanal .subitem.selected {
                outline: 3px solid rgba(0, 158, 247, .22);
                outline-offset: 2px;
            }

        .plan-semanal .subrow {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
        }

        .plan-semanal .subname {
            margin: 0;
            font-weight: 800;
            font-size: .9rem;
            color: var(--ps-text);
        }

        .plan-semanal .submeta {
            margin-top: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            color: var(--ps-muted);
            font-size: .8rem;
        }

        /* CENTER: Board */
        .plan-semanal #board {
            scrollbar-width: thin;
        }

        .plan-semanal .ps-col {
            min-width: 260px;
            max-width: 260px;
            border: 1px solid var(--ps-line);
            border-radius: var(--ps-radius);
            background: #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .plan-semanal .ps-col-head {
            padding: 12px;
            border-bottom: 1px solid rgba(15,23,42,.08);
            background: linear-gradient(180deg, rgba(15,23,42,.02), transparent);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .plan-semanal .ps-col-title {
            margin: 0;
            font-weight: 900;
            font-size: .92rem;
            color: var(--ps-text);
        }

    .dropzone {
        min-height: 140px;
        padding: 8px;
        border: 2px dashed #dbe3f3;
        border-radius: 12px;
        background-color: #f9fbff;
    }

    .plan-semanal .ps-col-date {
        font-size: .8rem;
        color: var(--ps-muted);
        white-space: nowrap;
    }

    .plan-semanal .ps-dropzone {
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 520px;
    }

    .plan-semanal .ps-col.dragover {
        outline: 2px dashed rgba(0, 158, 247, .35);
        outline-offset: -8px;
    }

    /* Cards (Tarjetas) */
    .plan-semanal .cardtask {
        border: 1px solid rgba(15,23,42,.12);
        border-radius: 14px;
        background: #fff;
        padding: 12px 12px 12px 14px;
        box-shadow: 0 10px 18px rgba(15,23,42,.06);
        cursor: grab;
        position: relative;
        transition: .15s ease;
    }

        .plan-semanal .cardtask:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 26px rgba(15,23,42,.10);
        }

        .plan-semanal .cardtask:active {
            cursor: grabbing;
        }

        .plan-semanal .cardtask.ghost {
            opacity: .55;
        }

        /* bar color por estado */
        .plan-semanal .cardtask .bar {
            position: absolute;
            left: 0;
            top: 12px;
            bottom: 12px;
            width: 5px;
            border-radius: 999px;
            background: #009EF7; /* default primary */
        }

    .plan-semanal .status-pendiente .bar {
        background: #009EF7;
    }

    .plan-semanal .status-proceso .bar {
        background: #FFC700;
    }

    .plan-semanal .status-hecho .bar {
        background: #50CD89;
    }

    .plan-semanal .status-bloqueado .bar {
        background: #F1416C;
    }

    .plan-semanal .ctitle {
        margin: 0 0 8px 10px;
        font-weight: 900;
        font-size: .92rem;
        color: var(--ps-text);
        line-height: 1.25;
    }

    .plan-semanal .cmeta {
        margin-left: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        color: var(--ps-muted);
        font-size: .8rem;
    }

    .plan-semanal .pri {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        display: inline-block;
    }

        .plan-semanal .pri.p1 {
            background: #F1416C;
        }

        .plan-semanal .pri.p2 {
            background: #FFC700;
        }

        .plan-semanal .pri.p3 {
            background: #50CD89;
        }

    /* Panel derecho */
    .plan-semanal #detailPane .p-4.border-dashed.rounded {
        border-color: rgba(15,23,42,.18) !important;
        background: rgba(15,23,42,.02);
    }

    /* Toast (si usas tu toast) */
    .plan-semanal .toast {
        position: fixed;
        left: 16px;
        bottom: 16px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(15,23,42,.14);
        background: #fff;
        box-shadow: var(--ps-shadow);
        color: var(--ps-text);
        display: none;
        z-index: 1050;
    }

    /* Modal (si mantienes tu modal custom) */
    .plan-semanal .modal-backdrop {
        background: rgba(15,23,42,.35);
    }

    .plan-semanal .modal {
        background: #fff;
        border: 1px solid rgba(15,23,42,.14);
        border-radius: 18px;
        overflow: hidden;
    }

        .plan-semanal .modal header,
        .plan-semanal .modal footer {
            border-color: rgba(15,23,42,.10);
        }


    /* ===== CARD MEJORADA ===== */

    .plan-semanal .cardtask {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px 12px 10px 16px;
    }

    /* Header info */
    .plan-semanal .card-header-info {
        margin-left: 10px;
        line-height: 1.25;
    }

    /* Body */
    .plan-semanal .card-body-info {
        margin-left: 10px;
    }

    .plan-semanal .ctitle {
        font-weight: 800;
        font-size: .95rem;
        margin-bottom: 6px;
        line-height: 1.3;
    }

    /* Metadata */
    .plan-semanal .cmeta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    /* Footer actions */
    .plan-semanal .card-footer-actions {
        display: flex;
        gap: 6px;
        margin-left: 10px;
        margin-top: 4px;
        opacity: 0;
        transition: .15s ease;
    }

    .plan-semanal .cardtask:hover .card-footer-actions {
        opacity: 1;
    }

    /* Reduce badges */
    .plan-semanal .badge {
        font-size: .7rem;
        padding: .35em .55em;
    }

    .plan-semanal .cardtask:hover {
        transform: scale(1.02);
    }


    /* ===== CARD COMPACTA ===== */
    .plan-semanal .card-compact {
        padding: 8px 8px 6px 12px;
        gap: 4px;
    }

        /* Header */
        .plan-semanal .card-compact .card-header-info {
            margin-left: 8px;
            line-height: 1.1;
        }

        /* Body */
        .plan-semanal .card-compact .card-body-info {
            margin-left: 8px;
        }

        /* Título: mostrar todo el texto */
        .plan-semanal .card-compact .ctitle {
            white-space: normal !important;
            overflow: visible !important;
            text-overflow: unset !important;
            word-break: break-word; /* rompe palabras largas */
            overflow-wrap: anywhere; /* mejor para textos largos */
            line-height: 1.25;
        }

        /* Metadata pills */
        .plan-semanal .card-compact .cmeta {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

    .plan-semanal .meta-pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 1px 6px;
        font-size: .68rem;
        border-radius: 999px;
        background: #f1f5f9;
        color: #334155;
        white-space: nowrap;
    }

    /* Prioridad */
    .plan-semanal .pri-1 {
        background: #fee2e2;
        color: #991b1b;
    }

    .plan-semanal .pri-2 {
        background: #fef9c3;
        color: #854d0e;
    }

    .plan-semanal .pri-3 {
        background: #dcfce7;
        color: #166534;
    }

    /* Actions */
    .plan-semanal .card-actions {
        display: flex;
        gap: 4px;
        margin-left: 8px;
        opacity: 0;
        transition: .15s ease;
    }

    .plan-semanal .card-compact:hover .card-actions {
        opacity: 1;
    }

    /* Mini buttons */
    .plan-semanal .btn-xxs {
        padding: .15rem .25rem;
        min-height: auto;
    }



    /* ==========================================
           ESTILOS GENERALES
           ========================================== */

    /* Estilos para el área de arrastrar y soltar */
    .drop-area {
        transition: all 0.3s ease;
        cursor: pointer;
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .drop-area:hover {
            background-color: #f8f9fa;
            border-color: #007bff;
        }

        .drop-area.active {
            background-color: #e3f2fd;
            border-color: #0056b3;
            transform: scale(1.02);
        }

    .drop-area-content {
        text-align: center;
    }

    /* ==========================================
           SECCIÓN DEL ADJUNTO - COMPONENTE DE SUBIDA DE ARCHIVOS
           ========================================== */

    /* Estilos para la vista previa del archivo */
    .file-preview {
        margin-bottom: 20px;
    }

    .file-item {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 12px;
        transition: all 0.3s ease;
        animation: fadeIn 0.3s ease-in;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .file-item:hover {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .file-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .file-icon {
        font-size: 20px;
        margin-right: 12px;
        color: #6c757d;
    }

    .file-details {
        flex-grow: 1;
    }

    .file-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 3px;
        font-size: 0.9rem;
    }

    .file-size {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .file-actions {
        display: flex;
        gap: 8px;
    }

    .btn-remove {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
        transition: all 0.2s ease;
        padding: 4px 8px;
        font-size: 0.8rem;
    }

        .btn-remove:hover {
            background-color: #c82333;
            border-color: #bd2130;
            transform: scale(1.05);
        }

        .btn-remove:focus {
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

    /* Mensajes de estado */
    .status-message {
        margin-top: 10px;
        padding: 8px 12px;
        border-radius: 4px;
        display: none;
        font-size: 0.85rem;
    }

    .status-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    /* Ajustes para el modal */
    .modal .drop-area {
        min-height: 100px;
    }

    .modal .file-item {
        padding: 10px;
    }

    .modal .file-name {
        font-size: 0.85rem;
    }

    .modal .file-size {
        font-size: 0.75rem;
    }
    /* CONTENEDOR */
    .req-tree {
        font-size: 13px;
    }

        /* REQUERIMIENTO */
        .req-tree .req-item {
            margin-bottom: 8px;
        }

        .req-tree .req-row {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 8px;
            background: #eef3ff; /* azul claro */
            color: #1b2a4e;
            font-weight: 600;
            cursor: default;
        }

            .req-tree .req-row i {
                color: #3e97ff; /* primary metronic */
            }

        /* SUB LIST */
        .req-tree .sub-list {
            margin-top: 4px;
            padding-left: 16px;
        }

        /* SUBREQUERIMIENTO */
        .req-tree .sub-item {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            margin-bottom: 4px;
            border-radius: 6px;
            background: #f8f9fa; /* gris claro */
            color: #3f4254;
            cursor: pointer;
            transition: all .15s ease;
        }

            .req-tree .sub-item i {
                color: #50cd89; /* success metronic */
            }
            /* Hover */
            .req-tree .sub-item:hover {
                background: #e8fff3; /* verde claro */
            }

            /* Seleccionado */
            .req-tree .sub-item.selected {
                background: #50cd89; /* success */
                color: #fff;
            }

                .req-tree .sub-item.selected i {
                    color: #fff;
                }

    /* Responsive para el modal */
    @@media (max-width: 768px) {
        .file-info {
            flex-direction: column;
            align-items: flex-start;
        }

        .file-actions {
            margin-top: 8px;
            align-self: flex-end;
        }

        .file-icon {
            margin-right: 0;
            margin-bottom: 8px;
        }

        .drop-area {
            min-height: 100px;
        }
    }


</style>

<!--begin::Content-->
<div id="kt_app_content" class="app-content flex-column-fluid plan-semanal">
    <!--begin::Content container-->
    <div id="kt_app_content_container" class="app-container container-fluid">

        <div class="row g-5">

            <!-- LEFT: Requerimientos -->
            <div class="col-12 col-xl-2">
                <div class="card card-flush h-100">
                    <div class="card-header pt-5">
                        <div class="card-title d-flex align-items-center gap-2">
                            <i class="bi bi-diagram-3 fs-3 text-primary"></i>
                            <h3 class="fw-bold m-0">Requerimientos</h3>
                        </div>

                        <div class="card-toolbar">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-light-primary" id="btnExport">
                                    <i class="bi bi-filetype-json"></i> Export
                                </button>

                                <button type="button" class="btn btn-sm btn-light" id="btnClearSel" title="Limpiar selección">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card-body pt-2">
                        <div class="d-flex gap-2 mb-4">
                            <input id="qReq" class="form-control form-control-sm" placeholder="Buscar requerimiento / subrequerimiento..." />
                            <button type="button" class="btn btn-sm btn-primary" id="btnSearch">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>

                        <div class="text-muted fs-7">
                            Selecciona un <span class="fw-bold">SubRequerimiento</span> para ver su trazabilidad (derecha) y crear tarjetas del plan asociadas.
                        </div>

                        <div class="separator my-4"></div>

                        <!-- Tree -->
                        <div id="tree" class="req-tree"></div>
                    </div>
                </div>
            </div>

            <!-- CENTER: Plan Semanal -->
            <div class="col-12 col-xl-7">
                <div class="card card-flush h-100">
                    <div class="row pt-5 mx-4">
                        <div class="col-12">
                            <div class="row">
                                <div class="col-8">
                                    <select id="fTrabajador" class="form-select form-select-sm" style="min-width:220px;" data-control="select2" data-placeholder="Todos">
                                        <option></option>
                                    </select>
                                </div>
                                <div class="col-4">
                                    <select id="fEstado" class="form-select form-select-sm" data-control="select2" data-placeholder="Todos">
                                        <option value="0">Todos</option>
                                        <option value="pendiente">Pendiente</option>
                                        <option value="proceso">En Proceso</option>
                                        <option value="hecho">Hecho</option>
                                        <option value="bloqueado">Bloqueado</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-header pt-5">
                        <div class="card-title d-flex flex-column">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-calendar2-week fs-3 text-primary"></i>
                                <h3 class="fw-bold m-0">Plan Semanal</h3>
                            </div>
                            <div class="text-muted fs-7 mt-1" id="weekLabel"></div>
                        </div>

                        <div class="card-toolbar">
                            <div class="d-flex gap-2 flex-wrap">
                                <button type="button" class="btn btn-sm btn-light" id="btnPrev" title="Semana anterior">
                                    <i class="bi bi-chevron-left"></i>
                                </button>

                                <button type="button" class="btn btn-sm btn-light-primary" id="btnToday">
                                    <i class="bi bi-dot"></i> Hoy
                                </button>

                                <button type="button" class="btn btn-sm btn-light" id="btnNext" title="Semana siguiente">
                                    <i class="bi bi-chevron-right"></i>
                                </button>

                                <button type="button" class="btn btn-sm btn-primary" id="btnNewCard">
                                    <i class="bi bi-plus-lg"></i> Tarjeta
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card-body pt-2">
                        <div class="text-muted fs-7 mb-4">
                            Arrastra tarjetas entre días. Cada tarjeta apunta a un <span class="fw-bold">SubRequerimiento</span> (y opcional a una <span class="fw-bold">Observación</span>).
                        </div>

                        <!-- Board (scroll horizontal si son 7 columnas) -->
                        <div class="d-flex flex-nowrap gap-4 overflow-auto pb-3" id="board" style="min-height:520px;">
                            @* Aquí tu JS inyecta columnas/días *@
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Trazabilidad -->
            <div class="col-12 col-xl-3">
                <div class="card card-flush h-100">
                    <div class="card-header pt-5">
                        <div class="card-title d-flex align-items-center gap-2">
                            <i class="bi bi-bezier2 fs-3 text-primary"></i>
                            <h3 class="fw-bold m-0">Trazabilidad</h3>
                        </div>

                        <div class="card-toolbar">
                            <button type="button" class="btn btn-sm btn-primary" id="btnNewObs" disabled>
                                <i class="bi bi-chat-left-text"></i> Observación
                            </button>
                        </div>
                    </div>

                    <div class="card-body pt-2" id="detailPane">
                        <div class="border border-dashed rounded p-4 bg-light">
                            <div class="fw-bold">Selecciona un SubRequerimiento</div>
                            <div class="text-muted fs-7 mt-1">
                                Aquí verás el timeline de observaciones del cliente y el historial.
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>

    </div>
    <!--end::Content container-->
</div>
<!--end::Content-->
<!-- MODAL -->
<div class="modal fade" id="kt_modal_obs" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold m-0"><i class="bi bi-chat-left-text text-primary me-2"></i>Nueva Observación</h2>
                <button type="button" class="btn btn-icon btn-sm btn-light" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="modal-body py-5">
                <input type="hidden" id="obs_subreq" value="0" />
                <!-- IDs ocultos -->
                <!-- Resumen -->
                <div class="alert alert-info d-flex align-items-start">
                    <i class="bi bi-info-circle fs-4 me-3"></i>
                    <div class="fs-7">
                        Registra una observación del cliente. Puedes adjuntar un archivo (opcional).
                    </div>
                </div>

                <div class="row g-5">

                    <!-- comentario -->
                    <div class="col-12">
                        <label class="form-label fw-bold required">Comentario</label>
                        <textarea class="form-control" id="obs_comentario" rows="6"
                                  placeholder="Describe la observación..."></textarea>
                    </div>

                    <!-- severidad -->
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Severidad</label>
                        <select class="form-select" id="obs_severidad">
                            <option value="baja">Baja</option>
                            <option value="media">Media</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>

                    <!-- estado -->
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Estado</label>
                        <select class="form-select" id="obs_estado">
                            <option value="Abierta">Abierta</option>
                            <option value="En Progreso">En Progreso</option>
                            <option value="Resuelto">Resuelto</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Observado por</label>
                        <select class="form-select" id="cbo_observadopor">
                            <option value="1">Interna</option>
                            <option value="2">Cliente</option>
                        </select>
                    </div>

                    <!-- registradoPor -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Registrado por</label>
                        <input type="text" class="form-control" id="obs_registradoPor" readonly />
                    </div>

                    <!-- fechaRegistro -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Fecha registro</label>
                        <input type="text" class="form-control" id="obs_fechaRegistro" readonly />
                    </div>

                    <!-- cerradoPor -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Cerrado por</label>
                        <input type="text" class="form-control" id="obs_cerradoPor" readonly />
                    </div>

                    <!-- fechaCierre -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Fecha cierre</label>
                        <input type="text" class="form-control" id="obs_fechaCierre" readonly />
                    </div>
                    <!-- ID oculto para edición -->
                    <input type="hidden" id="obs_idObservacion" value="0" />
                    <!-- archivo -->
                    <!--<div class="col-md-12">
                        <label class="form-label fw-bold">Adjunto (opcional)</label>
                        <input type="file" class="form-control" id="obs_file" />
                        <div class="text-muted fs-8 mt-1">JPG, PNG, PDF (opcional).</div>
                    </div>-->
                    <!-- ==========================================
                    SECCIÓN DEL ADJUNTO - COMPONENTE DE SUBIDA DE ARCHIVOS
                    ========================================== -->
                    <div class="col-md-12">
                        <label class="form-label fw-bold">Adjunto (opcional)</label>

                        <!-- Área de arrastrar y soltar -->
                        <div id="drop-area-obs" class="drop-area border-2 border-dashed border-primary text-center p-3 mb-3" style="cursor: pointer;">
                            <div class="drop-area-content">
                                <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                                <p class="mb-0">Arrastra y suelta un archivo aquí</p>
                                <input type="file" id="obs_file" class="d-none">
                            </div>
                        </div>

                        <!-- Vista previa del archivo -->
                        <div id="file-preview-obs" class="file-preview" style="display: none;">
                            <div class="file-item">
                                <div class="file-info">
                                    <div class="d-flex align-items-center">
                                        <div class="file-icon">
                                            <i class="fas fa-file"></i>
                                        </div>
                                        <div class="file-details">
                                            <div class="file-name" id="preview-name-obs">Nombre del archivo</div>
                                            <div class="file-size" id="preview-size-obs">Tamaño del archivo</div>
                                        </div>
                                    </div>
                                    <div class="file-actions">
                                        <button class="btn btn-sm btn-remove" id="remove-file-btn-obs" title="Eliminar archivo">
                                            <i class="fas fa-trash" style="color: white"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mensaje cuando no hay archivo -->
                        <div id="no-file-message-obs" class="text-center text-muted py-3" style="display: none;">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p class="mb-0">No hay archivo seleccionado</p>
                        </div>

                    </div>

                    <!-- Campos ocultos para almacenar información del archivo -->
                    <input type="hidden" id="obs_nombreArchivo" />
                    <input type="hidden" id="obs_extension" />
                    <input type="hidden" id="obs_fileSize" />
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarObs">
                    <i class="bi bi-send"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>
<!--begin::Modal - Tarjeta-->
<div class="modal fade" id="kt_modal_tarjeta" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h2 class="fw-bold" id="kt_modal_tarjeta_title">
                    <i class="bi bi-kanban me-2 text-primary"></i> Tarjeta
                </h2>
                <div class="btn btn-icon btn-sm btn-light" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i>
                </div>
            </div>

            <div class="modal-body py-5" id="kt_modal_tarjeta_body">
                <!-- Aquí se inyecta el partial -->
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="kt_modal_tarjeta_save">
                    <i class="bi bi-check-lg"></i> Guardar
                </button>
            </div>

        </div>
    </div>
</div>
<!--end::Modal-->

<div class="toast" id="toast"></div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script>
    // ====== Datos "como antes" (ViewBag) ======
    const ID_PLAN = @idPlanSemana;
    const LUNES_ISO = "@lunes"; // yyyy-MM-dd
    const DAY_NAMES = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];
    const DOWNLOAD_URL = '@Url.Action("DescargarArchivo", "PlanSemanal")';
    var toastr;
    // Selección actual
    let selected = { reqId: null, subId: null, subNombre: null, reqCodigo: null, reqNombre: null };
    let CURRENT_SUBREQ_ID = 0;
    let CURRENT_SUBREQ_INFO = null;
    // Cache tree/carts
    let treeData = { reqs: [], subs: [] };
    let cardsData = [];
    let modalTarjeta;

    window.onSelectSubReq = function (idSubReq, info) {
        console.log("onSelectSubReq ejecutado:", idSubReq, info);

        CURRENT_SUBREQ_ID = idSubReq;
        CURRENT_SUBREQ_INFO = info || null;


        $("#btnNewObs").prop("disabled", false);

        loadObservaciones(idSubReq, info); // tu función real
    };
     $(document).on("click", "#tree .subitem *", function (e) {
         // si haces click en algo dentro, sube al padre subitem
         const $sub = $(this).closest(".subitem");
         if ($sub.length) $sub.trigger("click");
         console.log("CLICK SUBREQ:");
     });
     // Delegación: engancha al contenedor padre que SI existe desde el inicio
     $(document).on("click", "#tree .subitem", function (e) {

         const idSubReq = parseInt($(this).data("subreq") || "0", 10);
         if (!idSubReq) return;

         const info = {
             reqCodigo: $(this).data("reqcodigo") || "",
             reqNombre: $(this).data("reqnombre") || "",
             subNombre: $(this).data("subnombre") || ""
         };

         // UI selected
         $("#tree .subitem").removeClass("selected");
         $(this).addClass("selected");

         console.log("CLICK SUBREQ:", idSubReq, info);

         // Llamada
         onSelectSubReq(idSubReq, info);
     });
    function initSelect2() {
        $('[data-control="select2"]').select2({
            width: '100%'
        });
    }
    $(function () {
        modalTarjeta = new bootstrap.Modal(
            document.getElementById('kt_modal_tarjeta'),
            { backdrop: 'static' }
        );
        initSelect2()
        initFiltroTrabajador();
        $("#kt_modal_tarjeta_save").on("click", function () {
            const $form = $("#kt_modal_tarjeta_body").find("form");
            if ($form.length === 0) {
                modalTarjeta.hide();
                return;
            }
            const form = document.getElementById("frmTarjeta");

            const formData = new FormData(form);
            $.ajax({
                url: $form.attr("action"),
                type: "POST",
                //data: $form.serialize(),
                data: formData,
                processData: false, // 👈 OBLIGATORIO
                contentType: false,
                success: function (res) {
                    if (res && res.idResultado === 1) {
                        toastr.success(res.mensaje || "Guardado correctamente");
                        modalTarjeta.hide();
                        loadCards();
                        loadObservaciones(CURRENT_SUBREQ_ID, CURRENT_SUBREQ_INFO);
                    } else {
                        toastr.error(res?.mensaje || "No se pudo guardar");
                    }
                },
                error: function () {
                    toastr.error("Error al guardar la tarjeta");
                }
            });
        });
        renderWeekLabel();
        buildBoardCols();
        loadTree("");

        loadCards();

        $("#btnSearch").on("click", function(){ loadTree($("#qReq").val() || ""); });
        $("#qReq").on("keydown", function(e){ if(e.key === "Enter") loadTree($("#qReq").val() || ""); });

        $("#btnClearSel").on("click", function(){
            selected = { reqId:null, subId:null, subNombre:null, reqCodigo:null, reqNombre:null };
            $("#btnNewObs").prop("disabled", true)
            renderTree();
            renderDetailEmpty();
        });
        $("#btnExport").on("click", function(){
            const url = "@Url.Action("ExportarTareasSemanal", "PlanSemanal")?idPlanSemana=" + ID_PLAN + "&lunes=" + LUNES_ISO + "&idPersonaResponsable=" + (filtroTrabajador || "");
            window.location.href = url;
        });

        $("#btnNewCard").on("click", function () {
            console.log(1)
            if (!selected.reqId) {
                //toast("Selecciona un SubRequerimiento primero.");
                toastr.error("Selecciona un Requerimiento primero.");
                return;
            }
            if(!selected.subId){
                //toast("Selecciona un SubRequerimiento primero.");
                toastr.error("Selecciona un SubRequerimiento primero.");
                return;
            }
            openTarjetaModal(0, selected.subId, null, 0);
        });


        $("#btnNewObs").on("click", function () {

            // Setear subreq actual en el modal
            $("#obs_subreq").val(CURRENT_SUBREQ_ID);

            // Limpieza del formulario
            $("#obs_comentario").val("");
            $("#obs_severidad").val("media");
            $("#obs_estado").val("Abierta").trigger("change");

            // Título dinámico (opcional, pro)
            if (CURRENT_SUBREQ_INFO) {
                $("#kt_modal_obs .modal-header h2").html(`
            <i class="bi bi-chat-left-text text-primary me-2"></i>
            Observación – ${esc(CURRENT_SUBREQ_INFO.subNombre)}
        `);
            }

            // Abrir modal Metronic
            const modal = new bootstrap.Modal(
                document.getElementById("kt_modal_obs")
            );
            limpiarCamposArchivo();
            modal.show();
            $("#obs_fechaRegistro").flatpickr({
                 dateFormat: 'd/m/Y',
                 locale: spanishLocale,
                 minDate: "today", // Bloquear fechas anteriores a hoy
                 defaultDate: new Date(),
                 clickOpens: false,   // 🚫 No abre el calendario
                 allowInput: false
            });
            /*
            $("#obs_fechaCierre").flatpickr({
                 dateFormat: 'd/m/Y',
                 locale: spanishLocale,
                 minDate: "today", // Bloquear fechas anteriores a hoy
                 defaultDate: new Date(),
            });*/
            $('#obs_severidad').select2({
                 placeholder: 'Seleccione cliente',
                 width: '100%'
            });
            $('#cbo_observadopor').select2({
                  placeholder: 'Seleccione cliente',
                  width: '100%'
            });
            $('#obs_estado').select2({
                placeholder: 'Seleccione cliente',
                width: '100%'
            });
            $("#obs_registradoPor").val("@ViewBag.usuario")
        });
        // Navegación semana (recarga para que tu Index calcule lunes e IdPlanSemana real)
        $("#btnPrev").on("click", function(){
            const d = addDays(parseISO(LUNES_ISO), -7);
            window.location = "@Url.Action("Index","PlanSemanal")?fecha=" + formatISO(d);
        });
        $("#btnNext").on("click", function(){
            const d = addDays(parseISO(LUNES_ISO), 7);
            window.location = "@Url.Action("Index","PlanSemanal")?fecha=" + formatISO(d);
        });
        $("#btnToday").on("click", function(){
            window.location = "@Url.Action("Index","PlanSemanal")";
        });

        // Modal hooks
        $("#btnClose, #btnCancel").on("click", closeModal);
        $("#modalBackdrop").on("click", function(e){ if(e.target.id === "modalBackdrop") closeModal(); });

        // Guardar modal: submit del form parcial
        $("#btnSave").on("click", function(){
            const $form = $("#modalBody").find("form");
            if($form.length===0){ closeModal(); return; }

            $.ajax({
                url: $form.attr("action"),
                type: "POST",
                data: $form.serialize(),
                success: function(res){
                    if(res && res.idResultado === 1){ // exito
                        toast(res.mensaje || "Guardado");
                        closeModal();
                        loadCards();
                    } else {
                        toast((res && res.mensaje) ? res.mensaje : "No se pudo guardar");
                    }
                },
                error: function(xhr){
                    toast("Error al guardar: " + (xhr.responseText || ""));
                }
            });
        });
    });

   /* function onSelectSubReq(idSubReq, info) {
        CURRENT_SUBREQ_ID = idSubReq;
        CURRENT_SUBREQ_INFO = info || null;

      // info: { reqCodigo, reqNombre, subNombre } si lo tienes
      loadObservaciones(idSubReq, info);
    }*/

    function loadObservaciones(idSubReq, info) {

      $.get("@Url.Action("ListarObservaciones","PlanSemanal")", { idRequerimientoDetalle: idSubReq })
        .done(function(r){
          if(!r || !r.ok){ toastr.error(r?.error || "Error al listar observaciones"); return; }
            CURRENT_SUBREQ_ID = idSubReq;

          const lista = r.lista || [];
          // También cargar tareas
          loadTareas(idSubReq, info, lista);
        });
    }

    function loadTareas(idSubReq, info, observaciones) {
      $.get("@Url.Action("ListarTareasPorSubRequerimiento","PlanSemanal")", { idRequerimientoDetalle: idSubReq })
        .done(function(r){
          if(!r || !r.ok){ toastr.error(r?.error || "Error al listar tareas"); return; }
          const tareas = r.tareas || [];
          renderDetailPane(idSubReq, info, observaciones, tareas);
        })
        .fail(function(){
          // Si falla, renderizar solo con observaciones
          renderDetailPane(idSubReq, info, observaciones, []);
        });
    }

    function renderDetailPane(idSubReq, info, lista, tareas = []){
      // Determinar si hay contenido
      const hayObs = lista && lista.length > 0;
      const hayTareas = tareas && tareas.length > 0;

      // Generar HTML de tabs
      const tabsHtml = `
        <div class="d-flex flex-stack mb-4">
          <div>
            <div class="fw-bold">${esc(info?.reqCodigo || "")} ${esc(info?.reqNombre || "Requerimiento")}</div>
            <div class="text-muted fs-7">${esc(info?.subNombre || "SubRequerimiento")} (ID: ${idSubReq})</div>
          </div>
          <button class="btn btn-sm btn-primary" onclick="openObsModal(${idSubReq})">
            <i class="bi bi-chat-left-text"></i> Observación
          </button>
        </div>
        <div class="separator mb-4"></div>

        <!-- Tabs -->
        <ul class="nav nav-tabs nav-line-tabs nav-line-tabs-2x mb-5 fs-6" role="tablist">
          <li class="nav-item" role="presentation">
            <a class="nav-link active text-primary fw-bold" data-bs-toggle="tab" href="#tab-obs" aria-selected="${hayObs}" role="tab">
              <i class="bi bi-chat-dots me-2"></i>Observaciones (${lista.length})
            </a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link  text-primary fw-bold" data-bs-toggle="tab" href="#tab-tareas" aria-selected="${!hayObs && hayTareas}" role="tab">
              <i class="bi bi-kanban me-2"></i>Tareas (${tareas.length})
            </a>
          </li>
        </ul>

        <!-- Contenido de tabs -->
        <div class="tab-content" id="detailTabContent">
          <!-- Tab Observaciones -->
          <div class="tab-pane fade show active" id="tab-obs" role="tabpanel">
            ${renderObservaciones(lista, idSubReq)}
          </div>
          <!-- Tab Tareas -->
          <div class="tab-pane fade " id="tab-tareas" role="tabpanel">
            ${renderTareas(tareas, idSubReq)}
          </div>
        </div>
      `;

      $("#detailPane").html(tabsHtml);
    }

    function renderObservaciones(lista, idSubReq) {
      if(!lista || lista.length === 0){
        return `
          <div class="border border-dashed rounded p-4 bg-light text-center">
            <i class="bi bi-inbox fs-2 text-muted mb-2"></i>
            <div class="fw-bold">Sin observaciones</div>
            <div class="text-muted fs-7 mt-1">Este subrequerimiento no tiene observaciones registradas.</div>
          </div>
        `;
      }

      return lista.map(o => {
        const badge = o.estado === "Cerrada" ? "badge-light-success" : "badge-light-warning";
        const sev = (o.severidad || "").toLowerCase();
        const sevBadge = sev === "alta" ? "badge-light-danger" : sev === "baja" ? "badge-light" : "badge-light-primary";

        return `
          <div class="d-flex align-items-start gap-3 p-3 border rounded mb-3">
            <div class="symbol symbol-35px symbol-circle bg-light">
              <div class="symbol-label">
                <i class="bi bi-chat-dots text-primary"></i>
              </div>
            </div>

            <div class="flex-grow-1">
              <div class="d-flex flex-wrap gap-2 align-items-center">
                <span class="badge ${badge}">${esc(o.estado)}</span>
                <span class="badge ${sevBadge}">sev: ${esc(o.severidad || "media")}</span>
                ${o.esAsociado == 1 ? `
                    <span class="badge badge-light-success ms-2">
                    <i class="bi bi-check-circle"></i> Asociado
                    </span>` : ''
                }
                <span class="text-muted fs-8">por ${esc(o.registradoPor || "-")} · ${fmtDate(o.fechaRegistro)}</span>
              </div>

              <div class="mt-2">${esc(o.comentario || "")}</div>

              ${o.nombreArchivo ? `
                <div class="mt-2">
                <a href="${DOWNLOAD_URL}?idObservacion=${o.idObservacion}" target="_blank" class="btn btn-sm btn-light"><i class="bi bi-paperclip"></i> ${esc(o.nombreArchivo)}</a>
                </div>` : ``}

              <div class="mt-3">
                <button class="btn btn-sm btn-light-primary" onclick="editarObs(${o.idObservacion}, ${idSubReq})">
                  <i class="bi bi-pencil"></i> Editar
                </button>
                 ${o.esAsociado == 0 ? `
                  <button class="btn btn-sm btn-light-info"
                          onclick="asociarObs(${o.idObservacion}, ${idSubReq})">
                    <i class="bi bi-people"></i> Asociar
                  </button>` : ``}


                ${o.estado !== "Cerrada" ? `
                <button class="btn btn-sm btn-light-success" onclick="cerrarObs(${o.idObservacion}, ${idSubReq})">
                  <i class="bi bi-check2-circle"></i> Cerrar
                </button>` : ``}
              </div>
            </div>
          </div>
        `;
      }).join("");
    }
    function formatFechaLarga(fecha) {
        if (!fecha) return '';
        return new Intl.DateTimeFormat('es-ES', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        }).format(fecha);
    }


    function renderTareas(tareas, idSubReq) {
      if(!tareas || tareas.length === 0){
        return `
          <div class="border border-dashed rounded p-4 bg-light text-center">
            <i class="bi bi-kanban fs-2 text-muted mb-2"></i>
            <div class="fw-bold">Sin tareas</div>
            <div class="text-muted fs-7 mt-1">Este subrequerimiento no tiene tareas asociadas.</div>
          </div>
        `;
      }

      return tareas.map(t => {
        const estado = (t.estado || "pendiente").toLowerCase();
        const estadoBadge = estado === "hecho" ? "badge-light-success" :
                           estado === "proceso" ? "badge-light-warning" :
                           estado === "bloqueado" ? "badge-light-danger" : "badge-light-primary";

        const prioridad = t.prioridad || 2;
        const priClass = prioridad == 1 ? "text-danger" : prioridad == 2 ? "text-warning" : "text-success";

        return `
          <div class="d-flex align-items-start gap-3 p-3 border rounded mb-3 bg-white">
            <div class="symbol symbol-35px symbol-circle ${priClass} bg-light">
              <div class="symbol-label">
                <i class="bi bi-kanban"></i>
              </div>
            </div>

            <div class="flex-grow-1">
              <div class="d-flex flex-wrap gap-2 align-items-center">
                <span class="badge ${estadoBadge}">${esc(t.estado || "Pendiente")}</span>
                <span class="badge badge-light">P${prioridad}</span>
                ${t.idObservacion ? `<span class="badge badge-light-info"><i class="bi bi-link-45deg"></i> Con Obs.</span>` : ''}
                <span class="text-muted fs-8">
                  ${DAY_NAMES[t.dia || 0]} ${t.fechaDia ? formatFechaLarga(new Date(t.fechaDia)) : ''}
                </span>
              </div>

              <div class="mt-2 fw-bold">${esc(t.titulo || "Sin título")}</div>

              <div class="mt-1 text-muted fs-8">
                <i class="bi bi-person"></i> ${esc(t.responsable || "Sin asignar")}
                ${t.tieneAdjunto == 1 ? `<i class="bi bi-paperclip ms-2"></i>` : ''}
              </div>

              <div class="mt-3">
                <button class="btn btn-sm btn-light-primary" onclick="editarTarea(${t.idPlanDetalle})">
                  <i class="bi bi-pencil"></i> Editar
                </button>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    function editarTarea(idPlanDetalle) {
      // Buscar la tarjeta en cardsData
      const card = cardsData.find(c => c.idPlanDetalle === idPlanDetalle);
      if(card) {
        openTarjetaModal(idPlanDetalle, card.idRequerimientoDetalle, card.idObservacion, card.dia);
      }
    }

    function asociarObsATarea(idPlanDetalle, idSubReq) {
      // Abrir modal de observación para asociar
      openObsModal(idSubReq);
      // TODO: Podríamos pasar el idPlanDetalle para asociar después
    }

    function openObsModal(idSubReq){
      $("#obs_subreq").val(idSubReq);
      $("#obs_comentario").val("");
      $("#obs_severidad").val("media");
      new bootstrap.Modal(document.getElementById("kt_modal_obs")).show();
    }
    function formatearFecha(fecha) {
        if (!fecha) return "";

        const d = new Date(fecha);
        if (isNaN(d.getTime())) return "";

        return d.toLocaleDateString('es-ES');
    }
    function parseNetDate(netDate) {
        if (!netDate) return "";

        const match = /\/Date\((\d+)\)\//.exec(netDate);
        if (!match) return "";

        const date = new Date(parseInt(match[1], 10));
        return isNaN(date.getTime()) ? "" : date.toLocaleDateString('es-ES');
    }


    function editarObs(idObs, idSubReq){
       $.get("@Url.Action("ObtenerObservacion","PlanSemanal")", { idObservacion: idObs })
         .done(function(r){
           if(!r || !r.ok){ toastr.error(r?.error || "Error obteniendo observación"); return; }
           const obs = r.observacion;

           //INICIALIZAR LOS SELECT
            $('#obs_severidad').select2({
                placeholder: 'Seleccione cliente',
                width: '100%'
            });
            $('#cbo_observadopor').select2({
                placeholder: 'Seleccione cliente',
                width: '100%'
            });
             $('#obs_estado').select2({
                 placeholder: 'Seleccione cliente',
                 width: '100%'
             });
           // Populate modal
           $("#obs_subreq").val(idSubReq);
           $("#obs_comentario").val(obs.comentario || "");
           $("#obs_severidad").val(obs.severidad).trigger("change");

           $("#cbo_observadopor").val(obs.ObservadorPor || "1").trigger("change");
           $("#obs_registradoPor").val(obs.registradoPor || "");
           $("#obs_fechaRegistro").val(parseNetDate(obs.fechaRegistro));
           $("#obs_fechaCierre").val(parseNetDate(obs.fechaCierre));
           $("#obs_cerradoPor").val(obs.cerradoPor || "");
           $("#obs_idObservacion").val(idObs);
             // Si el estado es "Cerrada", agregar la opción y deshabilitar el select
             if (obs.estado === "Cerrada") {
                 $("#obs_estado").append('<option value="Cerrada" selected >Cerrada</option>');
                 $("#obs_estado").prop('disabled', true);
             } else {
                 $("#obs_estado option[value='Cerrada']").remove();
                 $("#obs_estado").val(obs.estado || "Abierta").trigger("change");
                 $("#obs_estado").prop('disabled', false);
             }
            // Cargar información del archivo adjunto si existe
           if (obs.nombreArchivo && obs.extension) {
               cargarArchivoAdjunto(obs.nombreArchivo, obs.extension, idObs);
           } else {
               // Limpiar la vista previa si no hay archivo
               limpiarCamposArchivo();
           }
           // Change title
           $("#kt_modal_obs .modal-header h2").html(`<i class="bi bi-chat-left-text text-primary me-2"></i>Editar Observación`);

           // Open modal
           new bootstrap.Modal(document.getElementById("kt_modal_obs")).show();
         })
         .fail(function(){ toastr.error("Error al obtener observación"); });
     }
    @*$("#btnGuardarObs").on("click", function(){
      const idSubReq = parseInt($("#obs_subreq").val()||"0",10);
      const comentario = $("#obs_comentario").val();
      const severidad = $("#obs_severidad").val();
      const estado = $("#obs_estado").val();

        $.post("@Url.Action("GuardarObservacion","PlanSemanal")", { idRequerimientoDetalle: idSubReq, comentario, severidad, estado: estado })
        .done(function(r){
          if(r && r.ok){
            toastr.success(r.mensaje || "Guardado");
            bootstrap.Modal.getInstance(document.getElementById("kt_modal_obs")).hide();
            // recarga panel
            loadObservaciones(idSubReq, { });
          }else{
            toastr.error(r?.mensaje || "No se pudo guardar");
          }
        });
    });*@
    $("#btnGuardarObs").on("click", function(){
      const idSubReq = parseInt($("#obs_subreq").val()||"0",10);
      const idObs = parseInt($("#obs_idObservacion").val()||"0",10);
      const comentario = $("#obs_comentario").val();
      const severidad = $("#obs_severidad").val();
      const estado = $("#obs_estado").val();
      const observadopor = $("#cbo_observadopor").val();
      const registradoPor = $("#obs_registradoPor").val();
      const fechaRegistro = $("#obs_fechaRegistro").val();
      const cerradoPor = $("#obs_cerradoPor").val();
      const fechaCierre = $("#obs_fechaCierre").val();
      const file = $("#obs_file")[0].files[0];
      const nombreArchivo = $("#obs_nombreArchivo").val();
      const extension = $("#obs_extension").val();

     const data = {
        idObservacion: idObs,
        idRequerimientoDetalle: idSubReq,
        comentario: comentario,
        severidad: severidad,
        estado: estado,
        observadopor: observadopor,
        registradoPor: registradoPor,
        fechaRegistro: fechaRegistro,
        cerradoPor: cerradoPor,
        fechaCierre: fechaCierre,
        nombreArchivo: nombreArchivo,
        extension: extension
      };

      const formData = new FormData();
      formData.append("data", JSON.stringify(data));
      if (file) {
        formData.append("file", file);
      }

      $.ajax({
        url: "@Url.Action("GuardarObservacion","PlanSemanal")",
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function(r){
          if(r && r.ok){
            toastr.success(r.mensaje || "Guardado");
            bootstrap.Modal.getInstance(document.getElementById("kt_modal_obs")).hide();
            // recarga panel
            loadObservaciones(idSubReq, { });
          }else{
            toastr.error(r?.mensaje || "No se pudo guardar");
          }
        },
        error: function(){
          toastr.error("Error al guardar la observación");
        }
      });
    });


    function cerrarObs(idObs, idSubReq){
      $.post("@Url.Action("CerrarObservacion","PlanSemanal")", { idObservacion: idObs })
        .done(function(r){
          if(r && r.ok){
            toastr.success(r.mensaje || "Cerrada");
            loadObservaciones(idSubReq, { });
          }else{
            toastr.error(r?.mensaje || "No se pudo cerrar");
          }
        });
    }
    function limpiarCamposArchivo() {
        // Limpiar el input de archivo
        $("#obs_file").val("");

        // Limpiar campos ocultos de archivo
        $("#obs_nombreArchivo").val("");
        $("#obs_extension").val("");
        $("#obs_fileSize").val("");

        // Limpiar la vista previa del archivo
        const filePreview = document.getElementById('file-preview-obs');
        const noFileMessage = document.getElementById('no-file-message-obs');

        if (filePreview) {
            filePreview.style.display = 'none';
        }
        if (noFileMessage) {
            noFileMessage.style.display = 'none';
        }

        // Limpiar la variable global de archivo actual
        if (typeof window.clearObservationFile === 'function') {
            window.clearObservationFile();
        }
    }
        // Función para cargar archivo adjunto al editar observación
   function cargarArchivoAdjuntoTask(nombreArchivo, extension, idTarea = 0) {


       // Mostrar la vista previa
       const filePreview = document.getElementById('file-preview-task');
       const noFileMessage = document.getElementById('no-file-message-task');
       const previewName = document.getElementById('preview-name-task');
       const previewSize = document.getElementById('preview-size-task');
       const fileIcon = filePreview.querySelector('.file-icon i');

       // Mostrar toda la sección del adjunto
       filePreview.style.display = 'block';
       noFileMessage.style.display = 'none';

       // Actualizar información del archivo
       previewName.textContent = nombreArchivo;
       previewSize.textContent = 'Archivo adjunto'; // No tenemos el tamaño real

       // Actualizar icono según el tipo de archivo
       const iconClass = getFileIconClassFromExtension(extension);
       fileIcon.className = `fas ${iconClass}`;

       // Actualizar campos ocultos
       $("#task_nombreArchivo").val(nombreArchivo);
       $("#task_extension").val(extension);
       $("#task_fileSize").val('0');


       // Rebuild actions
       const fileActions = document.querySelector('#file-preview-task .file-actions');
       fileActions.innerHTML = '';

       if (idTarea > 0) {
           const downloadBtn = document.createElement('button');
           downloadBtn.type = 'button';
           downloadBtn.className = 'btn btn-sm btn-primary';
           downloadBtn.innerHTML = '<i class="fas fa-download"></i> Descargar';
           downloadBtn.onclick = () => window.open('@Url.Action("DescargarArchivo", "PlanSemanal")?idObservacion=' + idTarea, '_blank');
           fileActions.appendChild(downloadBtn);
       }

       const removeBtn = document.createElement('button');
       removeBtn.type = 'button';
       removeBtn.className = 'btn btn-sm btn-remove';
       removeBtn.id = 'remove-file-btn-task';
       removeBtn.title = 'Eliminar archivo';
       removeBtn.innerHTML = '<i class="fas fa-trash" style="color: white"></i>';
       removeBtn.onclick = window.removeFile1;
       fileActions.appendChild(removeBtn);
   }


     // Función para cargar archivo adjunto al editar observación
    function cargarArchivoAdjunto(nombreArchivo, extension, idObs = 0) {


        // Mostrar la vista previa
        const filePreview = document.getElementById('file-preview-obs');
        const noFileMessage = document.getElementById('no-file-message-obs');
        const previewName = document.getElementById('preview-name-obs');
        const previewSize = document.getElementById('preview-size-obs');
        const fileIcon = filePreview.querySelector('.file-icon i');

        // Mostrar toda la sección del adjunto
        filePreview.style.display = 'block';
        noFileMessage.style.display = 'none';

        // Actualizar información del archivo
        previewName.textContent = nombreArchivo;
        previewSize.textContent = 'Archivo adjunto'; // No tenemos el tamaño real

        // Actualizar icono según el tipo de archivo
        const iconClass = getFileIconClassFromExtension(extension);
        fileIcon.className = `fas ${iconClass}`;

        // Actualizar campos ocultos
        $("#obs_nombreArchivo").val(nombreArchivo);
        $("#obs_extension").val(extension);
        $("#obs_fileSize").val('0');


        // Rebuild actions
        const fileActions = document.querySelector('#file-preview-obs .file-actions');
        fileActions.innerHTML = '';

        if (idObs > 0) {
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'btn btn-sm btn-primary';
            downloadBtn.innerHTML = '<i class="fas fa-download"></i> Descargar';
            downloadBtn.onclick = () => window.open('@Url.Action("DescargarArchivo", "PlanSemanal")?idObservacion=' + idObs, '_blank');
            fileActions.appendChild(downloadBtn);
        }

        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn btn-sm btn-remove';
        removeBtn.id = 'remove-file-btn-obs';
        removeBtn.title = 'Eliminar archivo';
        removeBtn.innerHTML = '<i class="fas fa-trash" style="color: white"></i>';
        removeBtn.onclick = window.removeFile;
        fileActions.appendChild(removeBtn);
    }



    // Función para obtener la clase del icono según la extensión
    function getFileIconClassFromExtension(extension) {
        const iconMap = {
            '.pdf': 'fa-file-pdf text-danger',
            '.doc': 'fa-file-word text-primary',
            '.docx': 'fa-file-word text-primary',
            '.xls': 'fa-file-excel text-success',
            '.xlsx': 'fa-file-excel text-success',
            '.ppt': 'fa-file-powerpoint text-warning',
            '.pptx': 'fa-file-powerpoint text-warning',
            '.txt': 'fa-file-alt text-secondary',
            '.jpg': 'fa-file-image text-info',
            '.jpeg': 'fa-file-image text-info',
            '.png': 'fa-file-image text-info',
            '.gif': 'fa-file-image text-info',
            '.zip': 'fa-file-archive text-warning',
            '.rar': 'fa-file-archive text-warning',
            '.mp3': 'fa-file-audio text-warning',
            '.mp4': 'fa-file-video text-danger',
            '.avi': 'fa-file-video text-danger'
        };

        return iconMap[extension.toLowerCase()] || 'fa-file';
    }
    // helpers
    function fmtDate(d){
      if(!d) return "";
      // si viene /Date(...)/
      if(typeof d === "string" && d.indexOf("/Date(") >= 0){
        const ms = parseInt(d.replace("/Date(","").replace(")/",""),10);
        return new Date(ms).toLocaleString();
      }
      return new Date(d).toLocaleString();
    }

    function initTrabajadorCombo() {
        const $t = $("#ddlTrabajador");
        const sel = parseInt($("#hdTrabSelected").val() || "0", 10);

        $.get("@Url.Action("ListarTrabajadores2", "Trabajador")")
          .done(function(r){
            if(!r || !r.ok){ toastr.error(r?.error || "Error trabajadores"); return; }

            $t.empty().append('<option></option>');
            (r.lista || []).forEach(x=>{
                $t.append(`<option value="${x.idPersona}">${esc(x.nombreCli)}</option>`);
            });

            if(sel > 0) $t.val(sel);

            if ($t.data("select2")) $t.select2("destroy");
            $t.select2({ dropdownParent: $("#kt_modal_tarjeta") });

          }).fail(function(){ toastr.error("No se pudo cargar trabajadores"); });
    }


    function renderWeekLabel(){
        const end = addDays(parseISO(LUNES_ISO), 6);
        $("#weekLabel").text(`${formatLong(parseISO(LUNES_ISO))} — ${formatLong(end)} (${LUNES_ISO})`);
    }

    function buildBoardCols(){
        const $board = $("#board");
        $board.html("");
        for(let d=0; d<7; d++){
            const date = addDays(parseISO(LUNES_ISO), d);
            const $col = $(`
              <div class="col" data-day="${d}">
                <h3>${DAY_NAMES[d]} <span>${formatShort(date)}</span></h3>
                <div class="dropzone" data-day="${d}"></div>
              </div>
            `);

            // drag drop
            $col.on("dragover", function(e){ e.preventDefault(); $col.addClass("dragover"); });
            $col.on("dragleave", function(){ $col.removeClass("dragover"); });
            $col.on("drop", function(e){
                e.preventDefault(); $col.removeClass("dragover");
                const id = e.originalEvent.dataTransfer.getData("text/cardId");
                if(!id) return;
                moverTarjeta(parseInt(id,10), d);
            });

            $board.append($col);
        }
    }

    // ========= AJAX =========
    function loadTree(q){
        $.get("@Url.Action("Tree","PlanSemanal")", { q: q || "" })
            .done(function(r){
                if(!r || !r.ok){ toast(r?.error || "Error Tree"); return; }
                treeData.reqs = r.reqs || [];
                treeData.subs = r.subs || [];
                renderTree();
            })
            .fail(function(){ toast("Error cargando tree"); });
    }
    let filtroTrabajador = null;

    function initFiltroTrabajador(){
        const $f = $("#fTrabajador");
        const $e = $("#fEstado");

      $.get("@Url.Action("ListarTrabajadores2", "Trabajador")")
        .done(function(r){
          if(!r || !r.ok){ toastr.error(r?.error || "Error trabajadores"); return; }
            filtroTrabajador = 0;
          $f.empty().append('<option value="0" seleccione>Todos</option>');
          (r.lista||[]).forEach(x=>{
              $f.append(`<option value="${x.idPersona}">${esc(x.nombreCli)}</option>`);
          });

          $f.select2(); // fuera de modal
          $f.on("change", function(){
            const v = $(this).val();
            filtroTrabajador = v ? parseInt(v,10) : null;
            loadCards(); // recarga con filtro
          });
            $e.on("change", function () {
                loadCards(); // recarga con filtro
            });
        });
    }

    function loadCards(){
        $.get("@Url.Action("ListarTarjetas","PlanSemanal")", {
            idPlanSemana: ID_PLAN,
            idPersonaResponsable: filtroTrabajador, estado: $("#fEstado").val() })
            .done(function(r){
                if(!r || !r.ok){ toast(r?.error || "Error Cards"); return; }
                cardsData = r.cards || [];
                renderCards();
            })
            .fail(function(){ toast("Error cargando tarjetas"); });
    }

    // ========= Render Tree =========
    function renderTree(){
        const $tree = $("#tree");
        $tree.html("");

        // Agrupar subs por requerimiento
        const subsByReq = {};
        (treeData.subs || []).forEach(s=>{
            subsByReq[s.idRequerimiento] = subsByReq[s.idRequerimiento] || [];
            subsByReq[s.idRequerimiento].push(s);
        });

        (treeData.reqs || []).forEach(r=>{
            const subs = subsByReq[r.idRequerimiento] || [];
            const open = (selected.reqId === r.idRequerimiento);

            const $req = $(`
                <div class="req ${open ? "open":""}" data-req="${r.idRequerimiento}">
                  <div class="req-head">
                    <div>
                      <p class="req-title">${esc(r.codigo)} — ${esc(r.nombre)}</p>
                      <div class="req-meta">
                        <span class="pill"><i class="bi bi-diagram-3"></i> ${subs.length} SubReq</span>
                      </div>
                    </div>
                    <div class="req-tools"></div>
                  </div>
                  <div class="sublist"></div>
                </div>
            `);

            $req.find(".req-head").on("click", function(ev){
                if($(ev.target).closest(".iconbtn").length) return;
                if(selected.reqId === r.idRequerimiento && !selected.subId){
                    selected.reqId = null;
                }else{
                    selected.reqId = r.idRequerimiento;
                    if(selected.subId){
                        const has = subs.some(x=>x.idRequerimientoDetalle === selected.subId);
                        if(!has) selected.subId = null;
                    }
                }
                renderTree();
                if(!selected.subId) renderDetailEmpty();
            });

            const $sublist = $req.find(".sublist");
            subs.forEach(s=>{
                const isSel = (selected.subId === s.idRequerimientoDetalle);
                const $sub = $(`
                    <div class="subitem ${isSel ? "selected":""}" data-sub="${s.idRequerimientoDetalle}">
                      <div class="subrow">
                        <div>
                          <p class="subname">${esc(s.nombre)}</p>
                          <div class="submeta">
                            <span class="pill"><i class="bi bi-flag"></i> ${esc(s.estado || "Pendiente")}</span>
                            <span class="pill"><i class="bi bi-exclamation-circle"></i> P${(s.prioridad||2)}</span>
                          </div>
                        </div>
                        <div class="subtools"></div>
                      </div>
                    </div>
                `);

                $sub.on("click", function(){
                    selected.reqId = r.idRequerimiento;
                    selected.subId = s.idRequerimientoDetalle;
                    selected.subNombre = s.nombre;
                    selected.reqCodigo = r.codigo;
                    selected.reqNombre = r.nombre;
                    renderTree();
                    renderDetailSelected();
                    var info= {
                         reqCodigo: r.codigo,
                         reqNombre: s.nombre,
                         subNombre: r.nombre
                    }
                     onSelectSubReq(s.idRequerimientoDetalle, info);
                    console.log(1)
                });


                $sublist.append($sub);
            });

            $tree.append($req);
        });
    }

    // ========= Render Cards =========
    function renderCards(){
        // limpiar dropzones
        $("#board .dropzone").html("");

        (cardsData || []).forEach(c=>{
            const d = c.dia ?? 0;
            const $zone = $(`#board .dropzone[data-day="${d}"]`);
            if($zone.length===0) return;

            const priClass = (c.prioridad==1 ? "p1" : (c.prioridad==2 ? "p2" : "p3"));
            const status = (c.estado || "pendiente").toLowerCase();

            const $card = $(`
                <div class="cardtask card-compact status-${esc(status)}" draggable="true" data-id="${c.idPlanDetalle}">

                    <!-- Barra de estado -->
                    <div class="bar"></div>

                    <!-- Header -->
                    <div class="card-header-info">
                        <div class="fw-bold text-primary fs-9 lh-1">
                            ${esc(c.reqCodigo)} · ${esc(c.subNombre)}
                        </div>
                        <div class="text-muted fs-9 lh-1">
                            ${esc(c.reqNombre)}
                        </div>
                    </div>

                    <!-- Body -->
                    <div class="card-body-info">
                        <div class="ctitle lh-sm" style="text-align:left;">
                            ${esc(c.titulo)}
                        </div>

                        <div class="cmeta">
                            <span class="meta-pill">
                                <i class="bi bi-person"></i> ${esc(c.responsable || "—")}
                            </span>

                            <span class="meta-pill">
                                <i class="bi bi-calendar-event"></i> ${esc((c.fechaDia || "").substring(0, 10))}
                            </span>
                            ${c.tieneAdjunto == 1 ? `
                            <span class="meta-pill">
                                <i class="bi bi-paperclip"></i>
                            </span>` : ``}
                            <span class="meta-pill pri-${c.prioridad}">
                                P${c.prioridad}
                            </span>

                            ${c.idObservacion ? `
                            <span class="meta-pill">
                                <i class="bi bi-chat-left-text"></i>
                            </span>` : ``}
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="card-actions">
                        <button class="btn btn-icon btn-xxs btn-light-primary" data-act="edit">
                            <i class="bi bi-pencil fs-8"></i>
                        </button>
                        <button class="btn btn-icon btn-xxs btn-light-danger" data-act="del">
                            <i class="bi bi-trash fs-8"></i>
                        </button>
                    </div>

                </div>
                `);


            $card.on("dragstart", function(e){
                $card.addClass("ghost");
                e.originalEvent.dataTransfer.setData("text/cardId", c.idPlanDetalle);
            });
            $card.on("dragend", function(){ $card.removeClass("ghost"); });

            $card.find('[data-act="edit"]').on("click", function(ev){
                ev.preventDefault();
                openTarjetaModal(c.idPlanDetalle, c.idRequerimientoDetalle, c.idObservacion, c.dia);
            });
            $card.find('[data-act="del"]').on("click", function(ev){
                ev.preventDefault();
                eliminarTarjeta(c.idPlanDetalle);
            });

            $zone.append($card);
        });
    }

    // ========= Right panel =========
    function renderDetailEmpty(){
        $("#detailPane").html(`
          <div class="border border-dashed rounded p-4 bg-light text-center">
            <i class="bi bi-bezier2 fs-2 text-muted mb-2"></i>
            <div class="fw-bold">Selecciona un SubRequerimiento</div>
            <div class="text-muted fs-7 mt-1">Aquí verás las observaciones y tareas asociadas.</div>
          </div>
        `);
    }

    function renderDetailSelected(a){
        if(!selected.subId){
            renderDetailEmpty();
            return;
        }

        // Si ya hay un subrequerimiento seleccionado, usar loadObservaciones que maneja los tabs
        loadObservaciones(selected.subId, {
            reqCodigo: selected.reqCodigo,
            reqNombre: selected.reqNombre,
            subNombre: selected.subNombre
        });
    }
    function asociarObs(idObs, idSubReq) {
        // Abrir el modal de tarjeta enviando el idObservacion
        openTarjetaModal(0, idSubReq, idObs, 0);

    }
    //function SetupEvListenersTask() {
    //    const dropAreaTask = document.getElementById('drop-area-task');
    //    const fileInputTask = document.getElementById('task_file');
    //    const selectFileBtnTask = document.getElementById('select-file-btn-task');
    //    const filePreviewTask = document.getElementById('file-preview-task');
    //    const noFileMessageTask = document.getElementById('no-file-message-task');
    //    const removeFileBtnTask = document.getElementById('remove-file-btn-task');
    //    const previewNameTask = document.getElementById('preview-name-task');
    //    const previewSizeTask = document.getElementById('preview-size-task');

    //    // Campos ocultos para almacenar información del archivo
    //    const taskNombreArchivo = document.getElementById('task_nombreArchivo');
    //    const taskExtension = document.getElementById('task_extension');
    //    const taskFileSize = document.getElementById('task_fileSize');

    //    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    //        dropAreaTask.addEventListener(eventName, preventDefaults, false);
    //    });
    //    ['dragenter', 'dragover'].forEach(eventName => {
    //        dropAreaTask.addEventListener(eventName, highlight, false);
    //    });
    //    ['dragleave', 'drop'].forEach(eventName => {
    //        dropAreaTask.addEventListener(eventName, unhighlight, false);
    //    });
    //    dropAreaTask.addEventListener('drop', handleDrop, false);
    //    dropAreaTask.addEventListener('click', () => {
    //        fileInputTask.click();
    //    });

    //    fileInputTask.addEventListener('change', handleFile, false);


    //    removeFileBtnTask.addEventListener('click', function (e) {
    //        e.preventDefault();
    //        removeFile1();

    //        // Limpiar campos específicos
    //        $("#task_nombreArchivo").val("");
    //        $("#task_extension").val("");
    //    });
    //    function removeFile1() {
    //        currentFile = null;
    //        renderFilePreview();
    //        clearHiddenFields();
    //        showStatusMessage('Archivo eliminado', 'success');
    //    }
    //    function preventDefaults(e) {
    //        e.preventDefault();
    //        e.stopPropagation();
    //    }

    //    function highlight(e) {
    //        dropAreaTask.classList.add('active');
    //    }

    //    function unhighlight(e) {
    //        dropAreaTask.classList.remove('active');
    //    }

    //    function handleDrop(e) {
    //        const dt = e.dataTransfer;
    //        const droppedFiles = dt.files;

    //        if (droppedFiles.length > 0) {
    //            handleFile({ target: { files: droppedFiles } });
    //        }
    //    }
    //    function handleFile(e) {
    //        const selectedFile = e.target.files[0];

    //        if (selectedFile) {
    //            if (isValidFile(selectedFile)) {
    //                addFile(selectedFile);
    //            } else {
    //                showStatusMessage(`El archivo "${selectedFile.name}" no es válido.`, 'error');
    //            }
    //        }

    //        // Limpiar el input para permitir seleccionar el mismo archivo de nuevo
    //        fileInput.value = '';
    //    }

    //    function isValidFile(file) {
    //        // Validación de tamaño máximo (10MB)
    //        const maxSize = 10 * 1024 * 1024;
    //        if (file.size > maxSize) {
    //            showStatusMessage(`El archivo "${file.name}" excede el tamaño máximo de 10MB.`, 'error');
    //            return false;
    //        }
    //        return true;
    //    }

    //    function addFile(file) {
    //        // Sobre escribe el archivo actual
    //        currentFile = file;
    //        renderFilePreview();
    //        updateHiddenFields();
    //        showStatusMessage(`Archivo "${file.name}" seleccionado`, 'success');
    //    }

    //    function removeFile() {
    //        currentFile = null;
    //        renderFilePreview();
    //        clearHiddenFields();
    //        showStatusMessage('Archivo eliminado', 'success');
    //    }
    //    // Expose to global scope
    //    window.removeFile = removeFile;

    //    function renderFilePreview() {
    //        if (currentFile) {
    //            // Mostrar toda la sección del adjunto
    //            filePreviewTask.style.display = 'block';
    //            noFileMessageTask.style.display = 'none';

    //            // Actualizar información del archivo
    //            previewNameTask.textContent = currentFile.name;
    //            previewSizeTask.textContent = formatFileSize(currentFile.size);

    //            // Actualizar icono según el tipo de archivo
    //            const fileIcon = filePreviewTask.querySelector('.file-icon i');
    //            const iconClass = getFileIconClass(currentFile);
    //            fileIcon.className = `fas ${iconClass}`;
    //        } else {
    //            // Ocultar toda la sección del adjunto
    //            filePreviewTask.style.display = 'none';
    //            noFileMessageTask.style.display = 'none';
    //        }
    //    }

    //    function updateHiddenFields() {
    //        if (currentFile) {
    //            taskNombreArchivo.value = currentFile.name;
    //            taskExtension.value = getFileExtension(currentFile.name);
    //            taskFileSize.value = currentFile.size;
    //        }
    //    }

    //    function clearHiddenFields() {
    //         taskNombreArchivo.value = '';
    //         taskExtension.value = '';
    //         taskFileSize.value = '';
    //    }

    //    function getFileIconClass(file) {
    //        const extension = file.name.split('.').pop().toLowerCase();
    //        const iconMap = {
    //            'pdf': 'fa-file-pdf text-danger',
    //            'doc': 'fa-file-word text-primary',
    //            'docx': 'fa-file-word text-primary',
    //            'xls': 'fa-file-excel text-success',
    //            'xlsx': 'fa-file-excel text-success',
    //            'ppt': 'fa-file-powerpoint text-warning',
    //            'pptx': 'fa-file-powerpoint text-warning',
    //            'txt': 'fa-file-alt text-secondary',
    //            'jpg': 'fa-file-image text-info',
    //            'jpeg': 'fa-file-image text-info',
    //            'png': 'fa-file-image text-info',
    //            'gif': 'fa-file-image text-info',
    //            'zip': 'fa-file-archive text-warning',
    //            'rar': 'fa-file-archive text-warning',
    //            'mp3': 'fa-file-audio text-warning',
    //            'mp4': 'fa-file-video text-danger',
    //            'avi': 'fa-file-video text-danger'
    //        };

    //        return iconMap[extension] || 'fa-file';
    //    }

    //    function getFileExtension(filename) {
    //        return filename.split('.').pop().toLowerCase();
    //    }

    //    function formatFileSize(bytes) {
    //        if (bytes === 0) return '0 Bytes';

    //        const k = 1024;
    //        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    //        const i = Math.floor(Math.log(bytes) / Math.log(k));

    //        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    //    }

    //    function showStatusMessage(message, type) {
    //        // Eliminar mensajes anteriores
    //        const existingMessage = document.querySelector('.status-message');
    //        if (existingMessage) {
    //            existingMessage.remove();
    //        }

    //        // Crear nuevo mensaje
    //        const messageDiv = document.createElement('div');
    //        messageDiv.className = `status-message status-${type}`;
    //        messageDiv.textContent = message;

    //        // Insertar después del área de arrastrar y soltar
    //        const modalBody = dropAreaTask.closest('.modal-body');
    //        modalBody.insertBefore(messageDiv, dropAreaTask.nextSibling);

    //        // Mostrar mensaje
    //        messageDiv.style.display = 'block';

    //        // Ocultar después de 3 segundos
    //        setTimeout(() => {
    //            messageDiv.style.opacity = '0';
    //            setTimeout(() => messageDiv.remove(), 300);
    //        }, 3000);
    //    }

    //    // Función para obtener el archivo actual (para usar en el guardado)
    //    window.getObservationFile = function () {
    //        return currentFile;
    //    };

    //    // Función para limpiar el archivo (para usar cuando se cierra el modal)
    //    window.clearObservationFile = function () {
    //        currentFile = null;
    //        renderFilePreview();
    //        clearHiddenFields();
    //    };
    //}
    function SetupEvListenersTask() {
        const dropAreaTask = document.getElementById('drop-area-task');
        const fileInputTask = document.getElementById('task_file');
        const filePreviewTask = document.getElementById('file-preview-task');
        const noFileMessageTask = document.getElementById('no-file-message-task');
        const removeFileBtnTask = document.getElementById('remove-file-btn-task');
        const previewNameTask = document.getElementById('preview-name-task');
        const previewSizeTask = document.getElementById('preview-size-task');

        const taskNombreArchivo = document.getElementById('task_nombreArchivo');
        const taskExtension = document.getElementById('task_extension');
        const taskFileSize = document.getElementById('task_fileSize');

        let currentFile = null;

        // Drag & drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropAreaTask.addEventListener(eventName, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => dropAreaTask.addEventListener(eventName, highlight, false));
        ['dragleave', 'drop'].forEach(eventName => dropAreaTask.addEventListener(eventName, unhighlight, false));
        dropAreaTask.addEventListener('drop', handleDrop, false);
        dropAreaTask.addEventListener('click', () => fileInputTask.click());

        fileInputTask.addEventListener('change', handleFile, false);

        // Botón eliminar
        removeFileBtnTask.addEventListener('click', function (e) {
            e.preventDefault(); // evita submit
            removeFile1();
        });

        function removeFile1() {
            currentFile = null;
            renderFilePreview();
            clearHiddenFields();
            showStatusMessage('Archivo eliminado', 'success');
        }

        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        function highlight() { dropAreaTask.classList.add('active'); }
        function unhighlight() { dropAreaTask.classList.remove('active'); }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const droppedFiles = dt.files;
            if (droppedFiles.length > 0) handleFile({ target: { files: droppedFiles } });
        }

        function handleFile(e) {
            const selectedFile = e.target.files[0];
            if (selectedFile && isValidFile(selectedFile)) addFile(selectedFile);
            fileInputTask.value = ''; // limpiar input para volver a seleccionar
        }

        function isValidFile(file) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) { showStatusMessage('Archivo muy grande', 'error'); return false; }
            return true;
        }

        function addFile(file) {
            currentFile = file;
            renderFilePreview();
            updateHiddenFields();
            showStatusMessage(`Archivo "${file.name}" seleccionado`, 'success');
        }

        function renderFilePreview() {
            if (currentFile) {
                filePreviewTask.style.display = 'block';
                noFileMessageTask.style.display = 'none';
                previewNameTask.textContent = currentFile.name;
                previewSizeTask.textContent = formatFileSize(currentFile.size);
            } else {
                filePreviewTask.style.display = 'none';
                noFileMessageTask.style.display = 'none';
            }
        }

        function updateHiddenFields() {
            if (currentFile) {
                taskNombreArchivo.value = currentFile.name;
                taskExtension.value = getFileExtension(currentFile.name);
                taskFileSize.value = currentFile.size;
            }
        }

        function clearHiddenFields() {
            taskNombreArchivo.value = '';
            taskExtension.value = '';
            taskFileSize.value = '';
        }

        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB'], i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }

        function showStatusMessage(msg, type) {
            const existing = document.querySelector('.status-message'); if (existing) existing.remove();
            const div = document.createElement('div'); div.className = `status-message status-${type}`; div.textContent = msg;
            dropAreaTask.parentNode.insertBefore(div, dropAreaTask.nextSibling);
            setTimeout(() => { div.remove(); }, 3000);
        }

        // Funciones globales
        window.getObservationFile = () => currentFile;
        window.clearObservationFile = removeFile;
        window.removeFile1 = removeFile1;
    }

    function openTarjetaModal(idPlanDetalle, idRequerimientoDetalle, idObservacion, dia) {
        $.get("@Url.Action("FormTarjeta","PlanSemanal")", {
            idPlanSemana: ID_PLAN,
            idPlanDetalle: idPlanDetalle,
            idRequerimientoDetalle: idRequerimientoDetalle,
            idObservacion: idObservacion,
            dia: dia
        }).done(function (html) {

            $("#kt_modal_tarjeta_title").html(
                `<i class="bi bi-kanban me-2 text-primary"></i>
                 ${idPlanDetalle > 0 ? "Editar" : "Nueva"} Tarjeta`
            );

            $("#kt_modal_tarjeta_body").html(html);
            $("#hdAsociado").val(idObservacion)
            initTarjetaCombos();
            initTrabajadorCombo();
            SetupEvListenersTask();



            modalTarjeta.show();
            setTimeout(() => {

                if (idPlanDetalle > 0) {

                    var nombreArchivo = $("#task_nombreArchivo").val();
                    var extension = $("#task_extension").val();
                    if (nombreArchivo && extension) {
                        cargarArchivoAdjuntoTask(nombreArchivo, extension, idPlanDetalle);
                    } else {
                        // Limpiar la vista previa si no hay archivo
                        limpiarCamposArchivo();
                    }
                }
            }, 400)

        }).fail(function () {
            toastr.error("No se pudo cargar el formulario");
        });
    }

    function initTarjetaCombos() {

        const $req = $("#ddlRequerimiento");
        const $sub = $("#ddlSubRequerimiento");

        const $dia = $("#dia");
        const $prioridad = $("#prioridad");
        const $estado = $("#estado");

        // Preselección (viene del hidden)
        const subSelected = parseInt($("#hdSubSelected").val() || "0", 10);

        // Cargar tree real
        $.get("@Url.Action("Tree","PlanSemanal")", { q: "" })
            .done(function (r) {
                if (!r || !r.ok) { toastr.error(r?.error || "Error Tree"); return; }

                const reqs = r.reqs || [];
                const subs = r.subs || [];

                // Detectar requerimiento padre del sub seleccionado
                let reqSelected = 0;
                if (subSelected > 0) {
                    const subItem = subs.find(x => parseInt(x.idRequerimientoDetalle) === subSelected);
                    if (subItem) reqSelected = parseInt(subItem.idRequerimiento);
                }

                // Llenar Requerimientos
                $req.empty().append('<option></option>');
                reqs.forEach(rr => {
                    $req.append(`<option value="${rr.idRequerimiento}">${esc(rr.codigo)} — ${esc(rr.nombre)}</option>`);
                });

                // Set req seleccionado
                if (reqSelected > 0) $req.val(reqSelected);

                // Cargar subrequerimientos según req seleccionado
                fillSubsByReq(subs, $sub, reqSelected, subSelected);

                // change req => refresca subs
                $req.off("change.ps").on("change.ps", function () {
                    const idReq = parseInt($(this).val() || "0", 10);
                    fillSubsByReq(subs, $sub, idReq, 0);
                });

                // Re-init select2 (Metronic)
                if ($req.data("select2")) $req.select2("destroy");
                if ($sub.data("select2")) $sub.select2("destroy");
                if ($dia.data("select2")) $dia.select2("destroy");
                if ($estado.data("select2")) $estado.select2("destroy");
                if ($prioridad.data("select2")) $prioridad.select2("destroy");

                $req.select2({ dropdownParent: $("#kt_modal_tarjeta") });
                $sub.select2({ dropdownParent: $("#kt_modal_tarjeta") });
                $dia.select2({ dropdownParent: $("#kt_modal_tarjeta") });
                $estado.select2({ dropdownParent: $("#kt_modal_tarjeta") });
                $prioridad.select2({ dropdownParent: $("#kt_modal_tarjeta") });

            })
            .fail(function () {
                toastr.error("No se pudo cargar requerimientos");
            });
    }

    function fillSubsByReq(subs, $sub, idReq, subSelected) {
        $sub.empty().append('<option></option>');

        const lista = (subs || []).filter(s => parseInt(s.idRequerimiento) === parseInt(idReq));
        lista.forEach(s => {
            const label = `${esc(s.nombre)}${s.estado ? " (" + esc(s.estado) + ")" : ""}`;
            $sub.append(`<option value="${s.idRequerimientoDetalle}">${label}</option>`);
        });

        if (subSelected && subSelected > 0) $sub.val(subSelected);
    }


    function closeModal(){
        $("#modalBackdrop").hide();
        $("#modalBody").html("");
    }

    // ========= Actions =========
    function moverTarjeta(idPlanDetalle, dia){
        $.post("@Url.Action("MoverTarjeta","PlanSemanal")", { idPlanDetalle: idPlanDetalle, dia: dia })
            .done(function(res){
                if(res && res.idResultado === 1){
                    toast("Tarjeta movida");
                    loadCards();
                }else{
                    toast(res?.mensaje || "No se pudo mover");
                }
            })
            .fail(function(){ toast("Error al mover tarjeta"); });
    }

    function eliminarTarjeta(idPlanDetalle){
        if(!confirm("¿Eliminar tarjeta?")) return;

        $.post("@Url.Action("EliminarTarjeta","PlanSemanal")", { idPlanDetalle: idPlanDetalle })
            .done(function(res){
                if(res && res.idResultado === 1){
                    toast("Eliminado");
                    loadCards();
                }else{
                    toast(res?.mensaje || "No se pudo eliminar");
                }
            })
            .fail(function(){ toast("Error al eliminar"); });
    }

    // ========= Utils =========
    function toast(msg){
        const t = $("#toast");
        t.text(msg).show();
        clearTimeout(window.__toastTimer);
        window.__toastTimer = setTimeout(()=>t.hide(), 2600);
    }
    function esc(v){
        return String(v ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }
    function parseISO(s){
        const parts = (s || "").split("-");
        return new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]));
    }
    function addDays(d, n){
        const x = new Date(d.getTime());
        x.setDate(x.getDate()+n);
        return x;
    }
    function formatISO(d){
        const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${da}`;
    }
    function formatShort(d){
        const da=String(d.getDate()).padStart(2,"0"), mo=String(d.getMonth()+1).padStart(2,"0");
        return `${da}/${mo}`;
    }
    function formatLong(d){
        const months=["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
        return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }
</script>
<script>
    // ==========================================
    // COMPONENTE DE SUBIDA DE ARCHIVOS PARA EL MODAL
    // ==========================================
    //=== TAREAS ===//

    document.addEventListener('DOMContentLoaded', function () {
        // Elementos del DOM específicos para el modal
        //=== OBSERVACION ===//
        const dropArea = document.getElementById('drop-area-obs');
        const fileInput = document.getElementById('obs_file');
        const selectFileBtn = document.getElementById('select-file-btn-obs');
        const filePreview = document.getElementById('file-preview-obs');
        const noFileMessage = document.getElementById('no-file-message-obs');
        const removeFileBtn = document.getElementById('remove-file-btn-obs');
        const previewName = document.getElementById('preview-name-obs');
        const previewSize = document.getElementById('preview-size-obs');




        // Campos ocultos para almacenar información del archivo
        const obsNombreArchivo = document.getElementById('obs_nombreArchivo');
        const obsExtension = document.getElementById('obs_extension');
        const obsFileSize = document.getElementById('obs_fileSize');

        // Variables de estado
        let currentFile = null;

        // Eventos principales
        setupEventListeners();


        function setupEventListeners() {
            // Eventos del área de arrastrar y soltar
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });


            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });


            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });


            dropArea.addEventListener('drop', handleDrop, false);


            // Evento de click en el área de arrastrar y soltar (solo para el área, no para el botón)
            dropArea.addEventListener('click', () => {
                fileInput.click();

            });

            // Input de archivo
            fileInput.addEventListener('change', handleFile, false);

            // Botón de eliminar archivo
            removeFileBtn.addEventListener('click', removeFile);
            // Botón de eliminar archivo
            removeFileBtn.addEventListener('click', function () {
                removeFile();

                // Limpiar campos específicos
                $("#obs_nombreArchivo").val("");
                $("#obs_extension").val("");
            });


        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e) {
            dropArea.classList.add('active');
        }

        function unhighlight(e) {
            dropArea.classList.remove('active');
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const droppedFiles = dt.files;

            if (droppedFiles.length > 0) {
                handleFile({ target: { files: droppedFiles } });
            }
        }

        function handleFile(e) {
            const selectedFile = e.target.files[0];

            if (selectedFile) {
                if (isValidFile(selectedFile)) {
                    addFile(selectedFile);
                } else {
                    showStatusMessage(`El archivo "${selectedFile.name}" no es válido.`, 'error');
                }
            }

            // Limpiar el input para permitir seleccionar el mismo archivo de nuevo
            fileInput.value = '';
        }

        function isValidFile(file) {
            // Validación de tamaño máximo (10MB)
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showStatusMessage(`El archivo "${file.name}" excede el tamaño máximo de 10MB.`, 'error');
                return false;
            }
            return true;
        }

        function addFile(file) {
            // Sobre escribe el archivo actual
            currentFile = file;
            renderFilePreview();
            updateHiddenFields();
            showStatusMessage(`Archivo "${file.name}" seleccionado`, 'success');
        }

        function removeFile() {
            currentFile = null;
            renderFilePreview();
            clearHiddenFields();
            showStatusMessage('Archivo eliminado', 'success');
        }
        // Expose to global scope
        window.removeFile = removeFile;

        function renderFilePreview() {
            if (currentFile) {
                // Mostrar toda la sección del adjunto
                filePreview.style.display = 'block';
                noFileMessage.style.display = 'none';

                // Actualizar información del archivo
                previewName.textContent = currentFile.name;
                previewSize.textContent = formatFileSize(currentFile.size);

                // Actualizar icono según el tipo de archivo
                const fileIcon = filePreview.querySelector('.file-icon i');
                const iconClass = getFileIconClass(currentFile);
                fileIcon.className = `fas ${iconClass}`;
            } else {
                // Ocultar toda la sección del adjunto
                filePreview.style.display = 'none';
                noFileMessage.style.display = 'none';
            }
        }

        function updateHiddenFields() {
            if (currentFile) {
                obsNombreArchivo.value = currentFile.name;
                obsExtension.value = getFileExtension(currentFile.name);
                obsFileSize.value = currentFile.size;
            }
        }

        function clearHiddenFields() {
            obsNombreArchivo.value = '';
            obsExtension.value = '';
            obsFileSize.value = '';
        }

        function getFileIconClass(file) {
            const extension = file.name.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': 'fa-file-pdf text-danger',
                'doc': 'fa-file-word text-primary',
                'docx': 'fa-file-word text-primary',
                'xls': 'fa-file-excel text-success',
                'xlsx': 'fa-file-excel text-success',
                'ppt': 'fa-file-powerpoint text-warning',
                'pptx': 'fa-file-powerpoint text-warning',
                'txt': 'fa-file-alt text-secondary',
                'jpg': 'fa-file-image text-info',
                'jpeg': 'fa-file-image text-info',
                'png': 'fa-file-image text-info',
                'gif': 'fa-file-image text-info',
                'zip': 'fa-file-archive text-warning',
                'rar': 'fa-file-archive text-warning',
                'mp3': 'fa-file-audio text-warning',
                'mp4': 'fa-file-video text-danger',
                'avi': 'fa-file-video text-danger'
            };

            return iconMap[extension] || 'fa-file';
        }

        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showStatusMessage(message, type) {
            // Eliminar mensajes anteriores
            const existingMessage = document.querySelector('.status-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            // Crear nuevo mensaje
            const messageDiv = document.createElement('div');
            messageDiv.className = `status-message status-${type}`;
            messageDiv.textContent = message;

            // Insertar después del área de arrastrar y soltar
            const modalBody = dropArea.closest('.modal-body');
            modalBody.insertBefore(messageDiv, dropArea.nextSibling);

            // Mostrar mensaje
            messageDiv.style.display = 'block';

            // Ocultar después de 3 segundos
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => messageDiv.remove(), 300);
            }, 3000);
        }

        // Función para obtener el archivo actual (para usar en el guardado)
        window.getObservationFile = function () {
            return currentFile;
        };

        // Función para limpiar el archivo (para usar cuando se cierra el modal)
        window.clearObservationFile = function () {
            currentFile = null;
            renderFilePreview();
            clearHiddenFields();
        };
    });
</script>
